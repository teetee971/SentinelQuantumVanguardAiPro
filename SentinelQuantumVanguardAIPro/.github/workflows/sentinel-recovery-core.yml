name: ‚ôªÔ∏è Sentinel Recovery Core ‚Äî Restauration automatique en cas d‚Äôalt√©ration

on:
  workflow_run:
    workflows: ["üõ°Ô∏è Sentinel Threat Shield ‚Äî Surveillance d‚Äôint√©grit√© apr√®s d√©ploiement"]
    types: [completed]
  workflow_dispatch:

jobs:
  recover:
    runs-on: ubuntu-latest

    steps:
      - name: üîÑ Checkout du d√©p√¥t
        uses: actions/checkout@v4

      - name: üîç V√©rifier s‚Äôil y a eu une divergence
        id: check
        run: |
          if grep -q "Diff√©rences d√©tect√©es" .github/workflows/sentinel-threat-shield.yml; then
            echo "divergence=true" >> $GITHUB_OUTPUT
          else
            echo "divergence=false" >> $GITHUB_OUTPUT
          fi

      - name: ‚ôªÔ∏è Restaurer la derni√®re version saine
        if: steps.check.outputs.divergence == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "üö® Anomalie d√©tect√©e ‚Äî r√©cup√©ration de la derni√®re release valide..."
          mkdir -p recovery
          LATEST=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.assets[0].browser_download_url')
          curl -L "$LATEST" -o recovery/backup.zip
          unzip -o recovery/backup.zip -d recovery/
          npm install -g wrangler
          wrangler pages publish recovery/public --project-name=sentinelquantumvanguardaipro
          echo "‚úÖ Version restaur√©e avec succ√®s."

      - name: üì≤ Notification Telegram
        if: steps.check.outputs.divergence == 'true'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="‚ôªÔ∏è Sentinel Recovery Core : le site a √©t√© automatiquement restaur√© √† partir de la derni√®re sauvegarde saine."
