name: üõ°Ô∏è Sentinel Threat Shield ‚Äî Surveillance d‚Äôint√©grit√© apr√®s d√©ploiement

on:
  schedule:
    - cron: "*/30 * * * *"     # v√©rifie toutes les 30 minutes
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: üîÑ Checkout du d√©p√¥t
        uses: actions/checkout@v4

      - name: üì• T√©l√©charger la derni√®re version d√©ploy√©e depuis Cloudflare Pages
        run: |
          mkdir deployed
          curl -s https://sentinelquantumvanguardaipro.pages.dev/ -o deployed/index.html
          echo "‚úÖ Version en ligne r√©cup√©r√©e"

      - name: üîç Comparaison d‚Äôint√©grit√©
        run: |
          mkdir -p integrity
          sha256sum deployed/index.html > integrity/deployed_hash.txt
          if [ -f integrity/master.sig ]; then
            diff -q integrity/deployed_hash.txt integrity/checksum.txt || echo "‚ö†Ô∏è Diff√©rences d√©tect√©es !"
          else
            echo "‚ÑπÔ∏è Pas de hash ma√Ætre trouv√© ; la comparaison sera activ√©e au prochain build."
          fi

      - name: üö® Alerte Telegram en cas de divergence
        if: always()
        run: |
          DIFF=$(diff -q integrity/deployed_hash.txt integrity/checksum.txt || true)
          if [ -n "$DIFF" ]; then
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
              -d chat_id=${{ secrets.CHAT_ID }} \
              -d text="üö® Sentinel Threat Shield : divergence d√©tect√©e entre le d√©p√¥t et le site d√©ploy√© !"
          else
            echo "‚úÖ Aucune alt√©ration d√©tect√©e"
          fi
