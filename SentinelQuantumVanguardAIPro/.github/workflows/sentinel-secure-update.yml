name: ğŸ›¡ï¸ Sentinel Secure-Update â€” IntÃ©gritÃ© & signature

on:
  workflow_run:
    workflows: ["ğŸš€ Sentinel Auto-Deploy & Continuous Update"]
    types: [requested, completed]
  workflow_dispatch:

jobs:
  secure:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ” Scan de sÃ©curitÃ© des fichiers sensibles
        run: |
          echo "ğŸ” VÃ©rification des fichiers..."
          if grep -R "SECRET_KEY" . || grep -R "API_KEY" .; then
            echo "âŒ Fichier suspect dÃ©tectÃ©. ArrÃªt du processus."
            exit 1
          fi
          echo "âœ… Aucun secret dÃ©tectÃ©."

      - name: ğŸ§® Calcul du hash SHA-256 du build
        run: |
          mkdir -p integrity
          find . -type f ! -path "*/.git/*" -exec sha256sum {} \; > integrity/checksum.txt
          sha256sum integrity/checksum.txt > integrity/master.sig
          echo "âœ… Hash gÃ©nÃ©rÃ© et signÃ©."

      - name: ğŸªª Signature cryptographique
        run: |
          openssl genrsa -out integrity/private.pem 2048
          openssl rsa -in integrity/private.pem -outform PEM -pubout -out integrity/public.pem
          openssl dgst -sha256 -sign integrity/private.pem -out integrity/signature.bin integrity/checksum.txt
          echo "âœ… Signature crÃ©Ã©e pour la version du build."

      - name: ğŸ“¤ Sauvegarde sur GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          files: integrity/*
          name: "Sentinel Secure-Update â€” Signature & intÃ©gritÃ©"
          tag_name: "secure-${{ github.run_number }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“² Notification Telegram (sÃ©curitÃ©)
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.CHAT_ID }} \
            -d text="ğŸ›¡ï¸ Sentinel Secure-Update : intÃ©gritÃ© vÃ©rifiÃ©e, build signÃ© et validÃ©."
