name: üß† Sentinel AutoFixer v4.0 ‚Äî HealthAgent + CDNHeal + Telegram

on:
  schedule:
    - cron: "*/30 * * * *"  # ex√©cution toutes les 30 minutes
  workflow_dispatch:

jobs:
  sentinel-autofix:
    runs-on: ubuntu-latest

    steps:
      - name: üîÑ Checkout du d√©p√¥t
        uses: actions/checkout@v4

      - name: üß© V√©rifie et recr√©e les dossiers essentiels
        run: |
          mkdir -p public/dashboard public/documentation
          touch public/dashboard/.keep
          touch public/documentation/.keep
          echo "‚úÖ R√©pertoires essentiels v√©rifi√©s."

      - name: üíæ Commit automatique si changement
        run: |
          git config --global user.name "Sentinel AutoFixer"
          git config --global user.email "autofix@sentinel.local"
          git add public/dashboard/.keep public/documentation/.keep || true
          git diff --cached --quiet || git commit -m "üß† AutoFixer : R√©pertoires recr√©√©s automatiquement"
          git push || echo "‚ÑπÔ∏è Aucun changement √† pousser"

      - name: ‚òÅÔ∏è D√©ploiement Cloudflare Pages
        id: deploy
        uses: cloudflare/pages-action@v1
        with:
          apiToken: \${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: \${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: "sentinelquantumvanguardaipro"
          directory: "dist"

      - name: ü©∫ HealthAgent ‚Äî V√©rification de la disponibilit√©
        id: health
        run: |
          URLS=(
            "https://sentinelquantumvanguardaipro.pages.dev"
            "https://sentinelquantumvanguardaipro.pages.dev/dashboard/"
            "https://sentinelquantumvanguardaipro.pages.dev/documentation/"
            "https://sentinelquantumvanguardaipro.pages.dev/status/"
          )
          echo "üîç V√©rification de la disponibilit√©..."
          STATUS_REPORT=""
          ERRORS=0
          for URL in "\${URLS[@]}"; do
            HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}" "\$URL")
            if [ "\$HTTP_CODE" = "200" ]; then
              STATUS_REPORT+="‚úÖ OK (\$HTTP_CODE) ‚Äî \$URL\n"
            else
              STATUS_REPORT+="‚ö†Ô∏è ERREUR (\$HTTP_CODE) ‚Äî \$URL\n"
              ERRORS=$((ERRORS+1))
            fi
          done
          echo -e "\$STATUS_REPORT" > health_report.txt
          echo "ERREURS=\$ERRORS" >> \$GITHUB_ENV

      - name: üßπ CDNHeal ‚Äî Purge automatique du cache si erreur d√©tect√©e
        if: env.ERREURS != 0
        run: |
          echo "üö® Erreur d√©tect√©e ‚Äî purge du cache Cloudflare..."
          curl -X POST "https://api.cloudflare.com/client/v4/zones/\${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer \${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'
          echo "üßº Cache Cloudflare purg√© avec succ√®s."

      - name: üì≤ Notification Telegram
        if: always()
        run: |
          STATUS="‚úÖ D√©ploiement r√©ussi"
          if [ "\${{ job.status }}" != "success" ]; then STATUS="‚ö†Ô∏è Erreur d√©tect√©e"; fi

          MSG="ü§ñ *Sentinel AutoFixer v4.0*\n\n\${STATUS}\n\nü©∫ *Rapport HealthAgent :*\n$(cat health_report.txt)\n\nüåç [Acc√©der au site](https://sentinelquantumvanguardaipro.pages.dev)"

          if [ -n "\${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "\${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            curl -s -X POST "https://api.telegram.org/bot\${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="\${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d parse_mode="Markdown" \
              -d text="\$MSG"
          else
            echo "‚öôÔ∏è Telegram d√©sactiv√© (secrets manquants)"
          fi
