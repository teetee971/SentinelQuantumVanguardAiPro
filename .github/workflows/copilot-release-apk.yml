name: Build and Release APK (Copilot Trigger)

on:
  push:
    branches:
      - 'copilot/**'
    paths:
      - 'TRIGGER_RELEASE.txt'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: false
        default: '1.0.0'

jobs:
  build-and-release:
    name: Build Release APK and Create GitHub Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: android-app/package-lock.json

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Node dependencies
        working-directory: android-app
        run: npm ci

      - name: Generate debug keystore
        working-directory: android-app/android/app
        run: |
          # Generate a debug keystore for signing (use proper keystore for production)
          if [ ! -f debug.keystore ]; then
            keytool -genkeypair \
              -v \
              -storetype PKCS12 \
              -keystore debug.keystore \
              -alias androiddebugkey \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storepass android \
              -keypass android \
              -dname "CN=Android Debug,O=Android,C=US"
            echo "‚úÖ Debug keystore generated"
          else
            echo "‚úÖ Debug keystore already exists"
          fi

      - name: Make gradlew executable
        working-directory: android-app/android
        run: chmod +x gradlew

      - name: Build Release APK
        working-directory: android-app/android
        run: ./gradlew assembleRelease --no-daemon --stacktrace

      - name: Verify APK was built
        run: |
          APK_PATH="android-app/android/app/build/outputs/apk/release/app-release.apk"
          
          if [ ! -f "$APK_PATH" ]; then
            echo "‚ùå ERROR: APK not found at $APK_PATH"
            exit 1
          fi
          
          APK_SIZE=$(stat -c%s "$APK_PATH")
          MIN_SIZE=10485760  # 10 MB minimum
          
          echo "üì¶ APK found at: $APK_PATH"
          echo "üìä APK size: $APK_SIZE bytes ($(du -h "$APK_PATH" | cut -f1))"
          echo "‚öôÔ∏è  Minimum required: $MIN_SIZE bytes (10 MB)"
          
          if [ "$APK_SIZE" -lt "$MIN_SIZE" ]; then
            echo "‚ùå ERROR: APK is too small ($APK_SIZE bytes < 10 MB)"
            echo "‚ùå This indicates the build may have failed or produced an invalid APK"
            exit 1
          fi
          
          echo "‚úÖ APK size validation passed"

      - name: Determine version
        id: version
        run: |
          # Priority: workflow input > TRIGGER_RELEASE.txt > default
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ -f "TRIGGER_RELEASE.txt" ]; then
            VERSION=$(cat TRIGGER_RELEASE.txt | tr -d '[:space:]')
          else
            VERSION="1.0.0"
          fi
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "‚úÖ Release version: ${VERSION}"

      - name: Rename APK for release
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          cp android-app/android/app/build/outputs/apk/release/app-release.apk \
             "SentinelQuantumVanguardAIPro-v${VERSION}.apk"
          
          echo "‚úÖ APK renamed to: SentinelQuantumVanguardAIPro-v${VERSION}.apk"
          ls -lh "SentinelQuantumVanguardAIPro-v${VERSION}.apk"

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          cat > release_notes.md << 'EOF'
          # Sentinel Quantum Vanguard AI Pro - Android APK
          
          ## üì± Production Release v$VERSION
          
          ### ‚úÖ Features Included
          
          - **Real-time Call Detection** - Detects incoming calls using Android TelephonyManager
          - **Caller Identification** - Shows caller number, country, and risk level
          - **Spam Protection** - Block and flag suspicious numbers
          - **Call History** - Persistent local storage of all calls
          - **Privacy First** - All data stored locally, no cloud upload
          
          ### üì• Installation
          
          1. Download `SentinelQuantumVanguardAIPro-v$VERSION.apk`
          2. Enable "Install from unknown sources" in Android settings
          3. Install the APK
          4. Grant required permissions (Phone State, Call Log, Contacts)
          5. Open app and activate Phone Security module
          
          ### üìã Requirements
          
          - Android 6.0 (API 23) or higher
          - ~30 MB storage space
          - Phone permission access
          
          ### üîê Permissions
          
          - `READ_PHONE_STATE` - Detect incoming calls
          - `READ_CALL_LOG` - Access call history
          - `READ_CONTACTS` - Enrich caller ID
          - `RECEIVE_BOOT_COMPLETED` - Persist monitoring after reboot
          
          ### ‚ö†Ô∏è Important Notes
          
          - This is a **REAL functional app**, not a demo
          - All features work on real Android devices
          - No root access required
          - Google Play compliant permissions
          - 100% local data storage
          
          ### üêõ Known Limitations
          
          - Call blocking saves to local blocklist only (system blocking requires Telecom API)
          - Country detection is basic (based on phone number format)
          - Spam detection uses simple heuristics (ML model coming in future release)
          
          ### üìö Documentation
          
          - [Android README](https://github.com/teetee971/SentinelQuantumVanguardAiPro/blob/main/ANDROID_README.md)
          - [Test Guide](https://github.com/teetee971/SentinelQuantumVanguardAiPro/blob/main/APK_TEST_GUIDE.md)
          - [Technical Validation](https://github.com/teetee971/SentinelQuantumVanguardAiPro/blob/main/VALIDATION_FINALE.md)
          
          ### üîó Links
          
          - **GitHub Repository**: https://github.com/teetee971/SentinelQuantumVanguardAiPro
          - **Website**: https://sentinelquantumvanguardaipro.pages.dev
          
          ---
          
          **Built with:** React Native 0.73.2, Android SDK 34, JDK 17  
          **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
          **Build Type:** Release (Signed)
          EOF
          
          # Replace $VERSION placeholder
          sed -i "s/\$VERSION/$VERSION/g" release_notes.md
          
          echo "‚úÖ Release notes generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Release v${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          files: |
            SentinelQuantumVanguardAIPro-v*.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display release info
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          echo "================================================"
          echo "‚úÖ Release Published Successfully!"
          echo "================================================"
          echo "üì¶ APK: SentinelQuantumVanguardAIPro-v${VERSION}.apk"
          echo "üè∑Ô∏è  Tag: v${VERSION}"
          echo "üîó Release URL: https://github.com/teetee971/SentinelQuantumVanguardAiPro/releases/tag/v${VERSION}"
          echo "üì• Direct Download: https://github.com/teetee971/SentinelQuantumVanguardAiPro/releases/download/v${VERSION}/SentinelQuantumVanguardAIPro-v${VERSION}.apk"
          echo "================================================"
