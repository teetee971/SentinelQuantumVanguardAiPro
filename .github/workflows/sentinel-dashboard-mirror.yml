name: 🌍 Cloudflare Dashboard Mirror

on:
  workflow_run:
    workflows: ["🌙 Telegram Nightly Check Pro+", "🚀 Publish Sentinel Dashboard"]
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: 🔄 Checkout du dépôt
        uses: actions/checkout@v4

      - name: 📦 Préparer les fichiers du tableau de bord
        run: |
          mkdir -p dashboard
          cp logs/dashboard.html dashboard/index.html
          echo "<meta http-equiv='refresh' content='0; url=/status'>" > dashboard/redirect.html

      - name: 🌐 Génération de la carte Sentinel World Map
        run: |
          mkdir -p dashboard
          cat <<'HTML' > dashboard/map.html
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>🌐 Sentinel World Map — Quantum Vanguard AI</title>
<style>
body {background:#000;margin:0;overflow:hidden;font-family:system-ui,sans-serif;color:#fff;}
#globe {width:100vw;height:100vh;position:absolute;top:0;left:0;}
.panel {position:fixed;bottom:120px;right:20px;background:rgba(0,0,0,0.6);padding:12px 18px;border-radius:10px;font-size:14px;line-height:1.6;backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.15);}
.panel h3 {margin:0 0 6px;font-size:15px;color:#61dafb;}
.ok{color:#00ff9d;}.warn{color:#ffb347;}.err{color:#ff6b6b;}
.monitor{position:fixed;bottom:45px;left:0;width:100%;background:rgba(0,0,0,0.7);padding:10px;border-top:1px solid rgba(255,255,255,0.15);font-size:13px;color:#cce7ff;overflow-x:auto;white-space:nowrap;}
.agent{display:inline-block;background:#0f1620;margin-right:8px;padding:6px 10px;border-radius:6px;border:1px solid #123;min-width:140px;}
.agent span{display:block;font-size:11px;color:#7fa3b5;}
.console{position:fixed;bottom:0;left:0;width:380px;max-height:200px;background:rgba(0,0,0,0.8);border-top-right-radius:10px;border-top:1px solid rgba(255,255,255,0.15);border-right:1px solid rgba(255,255,255,0.15);overflow-y:auto;font-family:monospace;font-size:12px;padding:8px;color:#00ff9d;scrollbar-width:thin;}
.console b{color:#61dafb;}
.return-btn{position:fixed;top:15px;right:20px;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.2);border-radius:8px;color:#61dafb;padding:8px 14px;cursor:pointer;font-size:13px;transition:background 0.2s;}
.return-btn:hover{background:rgba(0,0,0,0.8);}
</style>
</head>
<body>
<button class="return-btn" onclick="window.location.href='/dashboard/index.html'">⬅️ Retour au Dashboard</button>
<div id="globe"></div>
<div class="panel">
<h3>🧠 Sentinel IA Nodes</h3>
<div>🇪🇺 <b>EU Node</b>: <span id="eu" class="ok">Online</span></div>
<div>🇺🇸 <b>US Node</b>: <span id="us" class="ok">Online</span></div>
<div>🇦🇺 <b>APAC Node</b>: <span id="apac" class="warn">Degraded</span></div>
<div>🇬🇵 <b>Caribbean Node</b>: <span id="carib" class="ok">Stable</span></div>
</div>
<div class="monitor" id="monitor"><b>🛰️ Live Agent Monitor</b><br><div id="agents"></div></div>
<div class="console" id="console"><b>AI Diagnostic Console</b><br></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/globe.gl@2.34.1/dist/globe.gl.min.js"></script>
<script>
const globe=Globe()(document.getElementById('globe'))
  .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-night.jpg')
  .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
  .pointAltitude('size').pointColor('color').pointLabel('name')
  .pointsData([{lat:48.8566,lng:2.3522,size:0.6,color