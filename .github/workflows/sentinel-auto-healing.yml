name: ðŸ§¬ Sentinel Auto-Healing â€” Autonomous Recovery System

on:
  schedule:
    - cron: "*/30 * * * *" # VÃ©rification toutes les 30 minutes
  workflow_dispatch:

jobs:
  autoheal:
    runs-on: ubuntu-latest

    steps:
      - name: âš™ï¸ Initialisation du cycle Auto-Healing
        run: |
          echo "ðŸ§¬ Initialisation Sentinel Auto-Healing Kernel..."
          mkdir -p logs
          echo "$(date '+%F %T') | Cycle Auto-Healing dÃ©marrÃ©" >> logs/heal.log

      - name: ðŸ” VÃ©rification accessibilitÃ© du site
        id: check
        run: |
          URL="https://sentinelquantumvanguardaipro.pages.dev"
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" $URL)
          echo "Code HTTP : $STATUS"
          if [ "$STATUS" -ne 200 ]; then
            echo "failure" > .last_status
          else
            echo "success" > .last_status
          fi

          # Conserver historique pour dÃ©tecter 2 Ã©checs consÃ©cutifs
          if [ -f .prev_status ]; then
            PREV=$(cat .prev_status)
          else
            PREV="success"
          fi

          echo "PrÃ©cÃ©dent : $PREV | Actuel : $(cat .last_status)"
          if [ "$PREV" = "failure" ] && [ "$(cat .last_status)" = "failure" ]; then
            echo "ðŸ§© Deux Ã©checs consÃ©cutifs dÃ©tectÃ©s â€” dÃ©clenchement du redÃ©ploiement."
            echo "redeploy=true" >> $GITHUB_OUTPUT
          else
            echo "redeploy=false" >> $GITHUB_OUTPUT
          fi
          mv .last_status .prev_status || true

      - name: ðŸš€ Relancer le workflow de dÃ©ploiement
        if: steps.check.outputs.redeploy == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "â™»ï¸ Lancement du redeploiement Sentinel-auto-redeploy.yml..."
          curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/sentinel-auto-redeploy.yml/dispatches \
            -d '{"ref":"main"}'
          echo "âœ… Redeploiement dÃ©clenchÃ© avec succÃ¨s."

      - name: ðŸ§  Notification Telegram â€” SuccÃ¨s ou Alerte
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ steps.check.outputs.redeploy }}" = "true" ]; then
            MSG="ðŸš¨ *Auto-Healing Sentinel activÃ© !*%0ADeux Ã©checs consÃ©cutifs dÃ©tectÃ©s.%0AðŸ” RedÃ©ploiement automatique lancÃ© sur Cloudflare Pages.%0AðŸ§  Supervision IA en cours."
          else
            MSG="âœ… *Sentinel Auto-Healing* : aucun problÃ¨me dÃ©tectÃ©.%0AðŸŒ Site stable et en ligne."
          fi
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=$MSG" \
            -d "parse_mode=Markdown"

      - name: ðŸ§¾ Journalisation
        run: |
          echo "$(date '+%T') | Fin du cycle Auto-Healing" >> logs/heal.log