name: ğŸŒ Sentinel Global Intelligence Grid

on:
  schedule:
    - cron: '0 */3 * * *'   # toutes les 3 heures
  workflow_dispatch:

jobs:
  global_grid:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§  AgrÃ©gation des donnÃ©es globales
        run: |
          mkdir -p grid
          echo "ğŸ›°ï¸ AgrÃ©gation des modules Sentinel..." > grid/aggregate.log
          for folder in telemetry security logs status resilience predictive integrity scheduler recovery aiops; do
            if [ -d "$folder" ]; then
              cp -r "$folder" grid/ 2>/dev/null || true
              echo "âœ… ImportÃ©: $folder" >> grid/aggregate.log
            fi
          done
          echo "ğŸ§© Fusion complÃ¨te terminÃ©e le $(date)" >> grid/aggregate.log

      - name: ğŸŒ GÃ©nÃ©ration du tableau de bord global HTML
        run: |
          mkdir -p public/grid
          echo "<html><head><title>Sentinel Global Intelligence Grid</title><meta http-equiv='refresh' content='10800'><style>body{background:#0d1117;color:#e6edf3;font-family:monospace;padding:20px;}h2{color:#58a6ff;}pre{background:#161b22;padding:10px;border-radius:8px;}</style></head><body>" > public/grid/index.html
          echo "<h2>ğŸŒ Sentinel Global Intelligence Grid</h2><hr>" >> public/grid/index.html
          echo "<h3>ğŸ§© Modules FusionnÃ©s</h3><pre>" >> public/grid/index.html
          ls grid >> public/grid/index.html
          echo "</pre><h3>ğŸ›°ï¸ DÃ©tails de Fusion</h3><pre>" >> public/grid/index.html
          cat grid/aggregate.log >> public/grid/index.html
          echo "</pre><hr><h3>ğŸ“Š SynthÃ¨se Globale</h3><pre>" >> public/grid/index.html
          echo "Date actuelle : $(date)" >> public/grid/index.html
          echo "\nModules Sentinel actifs : $(ls grid | wc -l)" >> public/grid/index.html
          echo "\nDonnÃ©es consolidÃ©es en provenance de : telemetry, security, resilience, predictive, integrity, scheduler, recovery, aiops" >> public/grid/index.html
          echo "</pre><h3>ğŸŒ Carte dâ€™activitÃ© IA (simulation)</h3><pre>" >> public/grid/index.html
          echo "ğŸ—ºï¸ Nodes actifs : 8\nğŸ“¡ RÃ©plication CDN : OK\nâš™ï¸ Flux CI/CD : Stable" >> public/grid/index.html
          echo "</pre><hr><p>ğŸ•’ DerniÃ¨re mise Ã  jour : $(date)</p></body></html>" >> public/grid/index.html
          echo "âœ… Tableau de bord global gÃ©nÃ©rÃ©."

      - name: ğŸš€ Publication sur Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: sentinelquantumvanguardaipro
          directory: public
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¡ Notification Telegram
        run: |
          MODULES=$(ls grid | wc -l)
          MSG="ğŸŒ Sentinel Global Intelligence Grid\nModules fusionnÃ©s: ${MODULES}\nLien Dashboard: https://sentinelquantumvanguardaipro.pages.dev/grid/\nğŸ•’ $(date)"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MSG"

      - name: âœ… Fin du cycle Global Grid
        run: echo "âœ”ï¸ Sentinel Global Intelligence Grid terminÃ© avec succÃ¨s."