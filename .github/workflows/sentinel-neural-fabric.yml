name: ğŸ§¬ Wave 24 â€“ Sentinel AI Neural Fabric (Auto-Adaptive Network)

on:
  schedule:
    - cron: "*/45 * * * *"   # toutes les 45 minutes
  workflow_dispatch:

jobs:
  neural_fabric:
    runs-on: ubuntu-latest
    name: ğŸ§  Neural Fabric Core
    steps:
      - name: ğŸš€ Initialisation
        run: |
          echo "ğŸ§¬ Lancement Neural Fabric"
          mkdir -p logs neural
          echo "$(date '+%F %T') | DÃ©but Wave 24" >> logs/neural.log

      - name: ğŸ“¡ AgrÃ©gation des waves actives
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=50" > neural/runs.json
          jq '[.workflow_runs[] | {workflow:.name,status:.status,conclusion:.conclusion,created_at:.created_at}]' neural/runs.json > neural/summary.json

      - name: ğŸ§® Construction du graphe de dÃ©pendances
        run: |
          echo "CrÃ©ation du graphe neural"
          jq -n \
            --arg date "$(date '+%F %T')" \
            --slurpfile data neural/summary.json \
            '{
              timestamp:$date,
              nodes:($data[0][] | group_by(.workflow) | map({
                id: .[0].workflow,
                last_run:(.[0].created_at),
                health:(if ([.[].conclusion | select(.=="success")] | length > 0) then "stable" else "unstable" end)
              })),
              edges:[
                {from:"Wave 16 â€“ Self-Healing", to:"Wave 17 â€“ Optimizer"},
                {from:"Wave 17 â€“ Optimizer", to:"Wave 18 â€“ Telemetry"},
                {from:"Wave 18 â€“ Telemetry", to:"Wave 19 â€“ Orchestrator"},
                {from:"Wave 19 â€“ Orchestrator", to:"Wave 20 â€“ Dashboard UI"},
                {from:"Wave 20 â€“ Dashboard UI", to:"Wave 21 â€“ Global Map"},
                {from:"Wave 21 â€“ Global Map", to:"Wave 22 â€“ Command Center"},
                {from:"Wave 22 â€“ Command Center", to:"Wave 23 â€“ Network Console"}
              ]
            }' > public/telemetry/neural_state.json
          echo "âœ… Graphe neural gÃ©nÃ©rÃ©" >> logs/neural.log

      - name: ğŸ§  Auto-commit
        run: |
          git config --global user.name "Sentinel-Neural-Fabric"
          git config --global user.email "fabric@sentinel"
          git add public/telemetry/neural_state.json
          git commit -m "ğŸ§¬ Update Neural Fabric state $(date +%T)" || echo "Aucune modif"
          git push || echo "Push non nÃ©cessaire"

      - name: ğŸ“² Notification Telegram
        if: always()
        run: |
          if [ -n "${{ secrets.TELEGRAM_WEBHOOK }}" ]; then
            MSG="ğŸ§¬ Neural Fabric executed â†’ graphe synchronisÃ© âœ…"
            curl -s -X POST ${{ secrets.TELEGRAM_WEBHOOK }} -d "text=$MSG"
          fi

      - name: ğŸ—‚ï¸ Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-neural-fabric-logs
          path: logs/
