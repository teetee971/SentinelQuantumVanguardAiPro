name: üåê Deploy ‚Äî Sentinel Quantum Vanguard AI Pro

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Set up job
        run: echo "Starting Cloudflare Pages deployment..."

      - name: üîÑ Checkout repository
        uses: actions/checkout@v4

      - name: üß∞ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üì¶ Install pnpm
        run: npm install -g pnpm

      - name: üì• Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: ‚öôÔ∏è Build project
        run: pnpm run build

      - name: üßÆ Copy audit dashboard
        run: mkdir -p dist/audit && echo "Build success at $(date)" > dist/audit/status.txt

      - name: üöÄ Deploy to Cloudflare Pages (auto-retry)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "=== Deploying Sentinel Quantum Vanguard AI Pro to Cloudflare Pages ==="
          for i in 1 2 3; do
            echo "Attempt $i/3..."
            npx wrangler pages deploy dist --project-name="sentinel-fusion" && break || {
              echo "‚ùå Deploy failed (Attempt $i)"
              if [ $i -lt 3 ]; then
                echo "üîÅ Retrying in 10 seconds..."
                sleep 10
              else
                echo "üö® All retries failed. Exiting."
                exit 1
              fi
            }
          done

      - name: ü©∫ Health Check
        if: success()
        run: |
          echo "Checking live deployment..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://sentinel-fusion.pages.dev)
          if [ "$STATUS" = "200" ]; then
            echo "‚úÖ Site is live and healthy!"
          else
            echo "‚ö†Ô∏è Deployment completed, but site not yet reachable (HTTP $STATUS)"
          fi
