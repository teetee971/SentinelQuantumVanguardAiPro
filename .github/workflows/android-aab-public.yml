name: Build Public AAB (Play Store)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version (ex: 1.0.1)"
        required: true
  push:
    tags:
      - "play-v*"

jobs:
  build-aab:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: android-app/package-lock.json

      - name: Install Node dependencies
        working-directory: android-app
        run: npm ci

      - name: Decode keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > release.keystore

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission
        run: chmod +x android-app/android/gradlew

      - name: Build Public AAB (Play Store)
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        working-directory: android-app/android
        run: |
          ./gradlew bundlePublicRelease \
            -Pandroid.injected.signing.store.file=../../release.keystore \
            -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$KEY_PASSWORD

      - name: Verify AAB was built
        run: |
          AAB_PATH="android-app/android/app/build/outputs/bundle/publicRelease/app-public-release.aab"
          
          if [ ! -f "$AAB_PATH" ]; then
            echo "‚ùå ERROR: AAB not found at $AAB_PATH"
            exit 1
          fi
          
          AAB_SIZE=$(stat -c%s "$AAB_PATH")
          
          echo "üì¶ AAB found at: $AAB_PATH"
          echo "üìä AAB size: $AAB_SIZE bytes ($(du -h "$AAB_PATH" | cut -f1))"
          echo "‚úÖ AAB validation passed"

      - name: Rename AAB for release
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#play-v}"  # Remove 'play-v' prefix if present
          VERSION="${VERSION#v}"       # Remove 'v' prefix if present
          
          cp android-app/android/app/build/outputs/bundle/publicRelease/app-public-release.aab \
             "SentinelQuantumVanguardAIPro-PUBLIC-v${VERSION}.aab"
          
          echo "‚úÖ AAB renamed to: SentinelQuantumVanguardAIPro-PUBLIC-v${VERSION}.aab"
          ls -lh "SentinelQuantumVanguardAIPro-PUBLIC-v${VERSION}.aab"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version && format('play-v{0}', github.event.inputs.version) || github.ref_name }}
          name: Sentinel Quantum Vanguard AI Pro (Play Store) ${{ github.event.inputs.version && format('v{0}', github.event.inputs.version) || github.ref_name }}
          body: |
            # üì± Google Play Store Release - AAB Bundle
            
            ## ‚úÖ Features (Public Build)
            - ‚úîÔ∏è Google Play Store compliant
            - ‚úîÔ∏è CallScreeningService API (no READ_CALL_LOG)
            - ‚úîÔ∏è ProGuard/R8 optimization enabled
            - ‚úîÔ∏è Resource shrinking active
            - ‚úîÔ∏è Compatible Android 10 ‚Üí 14+
            - ‚úîÔ∏è Production-ready
            
            ## üì• Installation
            **For Google Play Console upload only**
            
            This AAB file must be uploaded to Google Play Console.
            It cannot be installed directly on devices (use APK for direct installation).
            
            ## üîê Security
            - Code obfuscation enabled
            - HTTPS-only enforcement
            - 100% local data storage
            - No tracking
            
            ## üìã Differences from Institutional Build
            - ‚ùå No READ_CALL_LOG permission
            - ‚ùå No READ_SMS permission  
            - ‚ùå No RECORD_AUDIO permission
            - ‚úÖ Uses CallScreeningService API
            - ‚úÖ Google Play Policy compliant
            
            ## üéØ Upload Instructions
            1. Go to Google Play Console
            2. Select your app
            3. Navigate to Release ‚Üí Production
            4. Upload AAB file
            5. Complete store listing
            6. Submit for review
            
            **Application ID:** `com.sentinel.quantum.public`
            
            **Build Details:**
            - Workflow Run: ${{ github.run_number }}
            - Commit: ${{ github.sha }}
          files: |
            SentinelQuantumVanguardAIPro-PUBLIC-v*.aab
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display release info
        run: |
          VERSION="${{ github.event.inputs.version || github.ref_name }}"
          VERSION="${VERSION#play-v}"
          VERSION="${VERSION#v}"
          
          echo "================================================"
          echo "‚úÖ PLAY STORE AAB PUBLISHED!"
          echo "================================================"
          echo "üì¶ AAB: SentinelQuantumVanguardAIPro-PUBLIC-v${VERSION}.aab"
          echo "üè∑Ô∏è  Tag: play-v${VERSION}"
          echo "üîó Release URL: https://github.com/teetee971/SentinelQuantumVanguardAiPro/releases/tag/play-v${VERSION}"
          echo "üì• Direct Download: https://github.com/teetee971/SentinelQuantumVanguardAiPro/releases/download/play-v${VERSION}/SentinelQuantumVanguardAIPro-PUBLIC-v${VERSION}.aab"
          echo "================================================"
          echo ""
          echo "‚úÖ AAB FOR GOOGLE PLAY STORE UPLOAD"
          echo "‚úÖ USES CallScreeningService (NO READ_CALL_LOG)"
          echo "‚úÖ GOOGLE PLAY POLICY COMPLIANT"
          echo "================================================"
