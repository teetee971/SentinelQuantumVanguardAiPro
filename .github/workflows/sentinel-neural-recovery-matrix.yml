name: ğŸ§¬ Sentinel Neural Recovery Matrix

on:
  workflow_run:
    workflows:
      - "ğŸŒŒ Sentinel Nightly Health Monitor"
      - "ğŸ§© Sentinel Auto-Healer"
      - "ğŸ§  Sentinel Cognitive Dashboard"
      - "ğŸ§  Sentinel Resilience Core"
      - "ğŸ”® Sentinel Predictive Maintainer"
      - "ğŸ•“ Sentinel Adaptive Scheduler"
    types:
      - completed
  workflow_dispatch:

jobs:
  neural_recovery:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ§  DÃ©tection dâ€™anomalies ou dâ€™Ã©checs
        uses: actions/github-script@v7
        id: detect
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 10
            });
            const failed = runs.workflow_runs.filter(r => r.conclusion === "failure");
            fs.mkdirSync('recovery', { recursive: true });
            fs.writeFileSync('recovery/failed.json', JSON.stringify(failed, null, 2));
            core.setOutput("count", failed.length);
            core.notice(`ğŸ§© ${failed.length} workflows Ã©chouÃ©s dÃ©tectÃ©s.`);

      - name: ğŸš‘ Relance automatique des workflows critiques
        if: ${{ fromJSON(steps.detect.outputs.count) > 0 }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 5
            });
            for (const r of runs.workflow_runs.filter(x => x.conclusion === "failure")) {
              await github.rest.actions.reRunWorkflow({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: r.id
              });
              console.log(`â™»ï¸ RelancÃ© automatiquement : ${r.name}`);
            }

      - name: ğŸ§© Reconstruction des journaux corrompus
        run: |
          mkdir -p recovery/logs
          echo "ğŸ§  Reconstruction des journaux..." > recovery/logs/repair.txt
          for f in telemetry/report.txt logs/github-runs.json status/github.json; do
            [ -f "$f" ] && cp "$f" recovery/logs/
          done
          echo "âœ… Journaux restaurÃ©s le $(date)" >> recovery/logs/repair.txt

      - name: ğŸŒ GÃ©nÃ©ration du rapport Neural Recovery
        run: |
          mkdir -p public/recovery
          echo "<html><head><title>Sentinel Neural Recovery Matrix</title><meta http-equiv='refresh' content='3600'></head><body style='background:#0d1117;color:#e6edf3;font-family:monospace;padding:20px;'>" > public/recovery/index.html
          echo "<h2>ğŸ§¬ Sentinel Neural Recovery Matrix</h2><hr>" >> public/recovery/index.html
          echo "<h3>ğŸ©º Workflows Ã©chouÃ©s</h3><pre>" >> public/recovery/index.html
          cat recovery/failed.json >> public/recovery/index.html
          echo "</pre><h3>ğŸ§  Journaux restaurÃ©s</h3><pre>" >> public/recovery/index.html
          cat recovery/logs/repair.txt >> public/recovery/index.html
          echo "</pre><hr><p>ğŸ•’ DerniÃ¨re exÃ©cution : $(date)</p></body></html>" >> public/recovery/index.html
          echo "âœ… Rapport Neural Recovery gÃ©nÃ©rÃ©."

      - name: ğŸš€ Publication sur Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: sentinelquantumvanguardaipro
          directory: public
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¡ Notification Telegram
        run: |
          COUNT=$(jq length recovery/failed.json)
          MSG="ğŸ§¬ Sentinel Neural Recovery Matrix\nWorkflows Ã©chouÃ©s: ${COUNT}\nRapport: https://sentinelquantumvanguardaipro.pages.dev/recovery/\nğŸ•’ $(date)"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MSG"

      - name: âœ… Fin du cycle Neural Recovery
        run: echo "âœ”ï¸ Sentinel Neural Recovery Matrix terminÃ© avec succÃ¨s."