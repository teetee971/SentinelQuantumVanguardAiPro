name: ♻️ Sentinel Cloudflare Auto-Purge & Redeploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  purge_and_redeploy:
    name: 🧠 Purge Cloudflare Cache + Redeploy Sentinel
    runs-on: ubuntu-latest

    env:
      CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
      CF_PAGES_PROJECT: ${{ secrets.CF_PAGES_PROJECT }}
      SENTINEL_GITHUB_TOKEN: ${{ secrets.SENTINEL_GITHUB_TOKEN }}
      TELEGRAM_WEBHOOK: ${{ secrets.TELEGRAM_WEBHOOK }}
      TZ: ${{ secrets.TZ }}

    steps:
      - name: 🧩 Checkout repository
        uses: actions/checkout@v4

      - name: ⚙️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 📦 Install dependencies (safe mode)
        run: |
          npm ci || npm install
          echo "✅ Dependencies installed."

      - name: 🔄 Purge Cloudflare cache
        run: |
          echo "🧹 Purging Cloudflare cache for Sentinel..."
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/purge_cache" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'
          echo "✅ Cloudflare cache purged."

      - name: 🚀 Redeploy to Cloudflare Pages
        run: |
          echo "🌍 Redeploying Sentinel Quantum Vanguard AI Pro..."
          npx wrangler pages deploy dist --project-name="${CF_PAGES_PROJECT}" --branch main
          echo "✅ Redeployment completed."

      - name: 🧠 Notify Telegram (optional)
        if: env.TELEGRAM_WEBHOOK != ''
        run: |
          MESSAGE="🚀 *Sentinel Quantum Vanguard AI Pro* has been successfully redeployed and Cloudflare cache cleared ✅"
          curl -s -X POST "${TELEGRAM_WEBHOOK}" -d "text=${MESSAGE}&parse_mode=Markdown"

      - name: 🧩 Verify Deployment
        run: |
          echo "🔍 Checking deployment health..."
          curl -I "https://${CF_PAGES_PROJECT}.pages.dev" || echo "⚠️ Site may still be propagating."
          echo "✅ Sentinel Cloudflare Auto-Purge Cycle completed."