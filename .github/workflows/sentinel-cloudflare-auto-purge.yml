name: â™»ï¸ Sentinel Cloudflare Auto-Purge & Redeploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  purge_and_redeploy:
    name: ğŸ§  Purge Cloudflare Cache + Redeploy Sentinel
    runs-on: ubuntu-latest

    env:
      CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
      CF_PAGES_PROJECT: ${{ secrets.CF_PAGES_PROJECT }}
      SENTINEL_GITHUB_TOKEN: ${{ secrets.SENTINEL_GITHUB_TOKEN }}
      TELEGRAM_WEBHOOK: ${{ secrets.TELEGRAM_WEBHOOK }}
      TZ: ${{ secrets.TZ }}

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ“¦ Install dependencies (safe mode)
        run: |
          npm ci || npm install
          echo "âœ… Dependencies installed."

      - name: ğŸ”„ Purge Cloudflare cache
        run: |
          echo "ğŸ§¹ Purging Cloudflare cache for Sentinel..."
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/purge_cache" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'
          echo "âœ… Cloudflare cache purged."

      - name: ğŸš€ Redeploy to Cloudflare Pages
        run: |
          echo "ğŸŒ Redeploying Sentinel Quantum Vanguard AI Pro..."
          npx wrangler pages deploy dist --project-name="${CF_PAGES_PROJECT}" --branch main
          echo "âœ… Redeployment completed."

      - name: ğŸ§  Notify Telegram (optional)
        if: env.TELEGRAM_WEBHOOK != ''
        run: |
          MESSAGE="ğŸš€ *Sentinel Quantum Vanguard AI Pro* has been successfully redeployed and Cloudflare cache cleared âœ…"
          curl -s -X POST "${TELEGRAM_WEBHOOK}" -d "text=${MESSAGE}&parse_mode=Markdown"

      - name: ğŸ§© Verify Deployment
        run: |
          echo "ğŸ” Checking deployment health..."
          curl -I "https://${CF_PAGES_PROJECT}.pages.dev" || echo "âš ï¸ Site may still be propagating."
          echo "âœ… Sentinel Cloudflare Auto-Purge Cycle completed."