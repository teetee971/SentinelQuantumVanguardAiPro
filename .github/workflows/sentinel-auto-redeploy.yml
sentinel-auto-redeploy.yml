name: ğŸš€ Sentinel Quantum Vanguard AI â€” Auto Deploy & Site Check

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ“‚ Aller dans le dossier du projet
        working-directory: ./SentinelQuantumVanguardAiPro
        run: echo "ğŸ“ Dossier courant : $(pwd)"

      - name: ğŸ“¦ Installer les dÃ©pendances
        working-directory: ./SentinelQuantumVanguardAiPro
        run: |
          echo "ğŸ“¦ Installation des dÃ©pendances..."
          npm ci || npm install
          npm install @vitejs/plugin-react --save-dev
          npm install tailwindcss postcss autoprefixer --save-dev

      - name: ğŸ§± Build Vite + Tailwind
        working-directory: ./SentinelQuantumVanguardAiPro
        run: |
          echo "ğŸ—ï¸ Construction du projet avec Vite + Tailwind..."
          npm run build || (echo "âŒ Erreur de build : arrÃªt du workflow" && exit 1)

      - name: â˜ï¸ Purge du cache Cloudflare
        if: success()
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          echo "ğŸš€ Purge du cache Cloudflare..."
          curl -X POST "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/purge_cache" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}' \
            && echo "âœ… Purge Cloudflare terminÃ©e avec succÃ¨s."

      - name: ğŸŒ VÃ©rification accessibilitÃ© du site
        id: sitecheck
        run: |
          echo "ğŸ” VÃ©rification accessibilitÃ© du site..."
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://sentinelquantumvanguardaipro.pages.dev)
          echo "Code HTTP : $STATUS"
          if [ "$STATUS" -eq 200 ]; then
            echo "âœ… Site accessible"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Site inaccessible (code : $STATUS)"
            echo "result=failure" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¢ Notification Telegram (SuccÃ¨s)
        if: steps.sitecheck.outputs.result == 'success'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ğŸ“¨ Envoi de la notification Telegram (succÃ¨s)..."
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=âœ… *Sentinel Quantum Vanguard AI Pro* a Ã©tÃ© dÃ©ployÃ© et le site est accessible ğŸ‰%0AğŸŒ https://sentinelquantumvanguardaipro.pages.dev" \
            -d "parse_mode=Markdown"

      - name: ğŸ“¢ Notification Telegram (Ã‰chec ou InaccessibilitÃ©)
        if: steps.sitecheck.outputs.result == 'failure' || failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ğŸ“¨ Envoi de la notification Telegram (Ã©chec)..."
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=âš ï¸ *Ã‰chec du dÃ©ploiement ou site inaccessible Sentinel Quantum Vanguard AI Pro.*%0AğŸ” VÃ©rifie les logs GitHub Actions ou Cloudflare Pages.%0AğŸŒ https://sentinelquantumvanguardaipro.pages.dev" \
            -d "parse_mode=Markdown"