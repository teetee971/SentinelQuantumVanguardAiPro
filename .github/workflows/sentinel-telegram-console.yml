name: ğŸ¤– Console Telegram Sentinel Quantum Vanguard AI Pro

on:
  workflow_dispatch:
  repository_dispatch:
  schedule:
    - cron: "0 */6 * * *" # Mise Ã  jour toutes les 6h

env:
  BOT_TOKEN: "7630324617:AAGYNTiOIhHFDyT83Qt_DezDUxEzEJf-K9E"
  CHAT_ID: "5707814118"
  CLOUDFLARE_URL: "https://sentinelquantumvanguardaipro.pages.dev"

jobs:
  telegram-console:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ“Š Collecte des mÃ©triques systÃ¨me
        id: metrics
        run: |
          echo "ğŸ§  Collecte des mÃ©triques Sentinel" > metrics.txt
          echo "ğŸ•’ $(date '+%Y-%m-%d %H:%M:%S UTC')" >> metrics.txt
          echo "" >> metrics.txt
          echo "ğŸŒ Cloudflare Status:" >> metrics.txt
          if curl -Is ${CLOUDFLARE_URL} | grep "200" > /dev/null; then
            echo "âœ… En ligne (${CLOUDFLARE_URL})" >> metrics.txt
          else
            echo "âš ï¸ Hors ligne ou dÃ©lai de rÃ©ponse" >> metrics.txt
          fi
          echo "" >> metrics.txt
          echo "ğŸ“¦ Derniers dÃ©ploiements GitHub Actions:" >> metrics.txt
          gh run list --limit 5 --json name,conclusion,createdAt \
            --jq '.[] | "â€¢ \(.name) â†’ \(.conclusion) (\(.createdAt))"' >> metrics.txt
          echo "" >> metrics.txt
          echo "ğŸ§© Derniers commits:" >> metrics.txt
          git log -3 --pretty=format:"â€¢ %h â€“ %s (%ci)" >> metrics.txt

      - name: ğŸ“¡ Envoi du tableau de bord interactif sur Telegram
        run: |
          BASE_URL="https://api.telegram.org/bot${BOT_TOKEN}"
          MSG="ğŸ¤– *Console Sentinel Quantum Vanguard AI Pro*%0A"
          MSG+="ğŸ•’ $(date '+%Y-%m-%d %H:%M:%S UTC')%0A"
          MSG+="ğŸ§  Rapport automatisÃ© toutes les 6 heures.%0A%0A"
          MSG+="ğŸ”¹ *Statut actuel :*"
          MSG+="%0AğŸŒ Cloudflare : VÃ©rifiÃ©"
          MSG+="%0Aâš™ï¸ Build : Auto-Heal actif"
          MSG+="%0AğŸ“ˆ Logs : /report_24h & /report_7d disponibles%0A"

          BUTTONS=$(jq -nc --arg url1 "${CLOUDFLARE_URL}" \
            '{"inline_keyboard":[
              [{"text":"ğŸŒ Ouvrir le site","url":$url1}],
              [{"text":"ğŸ“Š Rapport Quotidien","callback_data":"daily"}],
              [{"text":"ğŸ“ˆ Rapport Hebdo","callback_data":"weekly"}],
              [{"text":"â™»ï¸ Forcer RedÃ©ploiement","callback_data":"redeploy"}],
              [{"text":"ğŸ” Lancer Auto-Heal","callback_data":"autoheal"}]
            ]}')

          curl -s -X POST "${BASE_URL}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="$MSG" \
            -d reply_markup="$BUTTONS"

          curl -s -F chat_id="${CHAT_ID}" -F document=@metrics.txt \
            "${BASE_URL}/sendDocument"
