name: üîÅ Auto Rollback on Failure ‚Äî Sentinel Quantum Vanguard AI Pro‚Ñ¢

on:
  workflow_run:
    workflows: ["üöÄ Sentinel Quantum Vanguard AI Pro ‚Äî AutoDeploy Cloud Edition"]
    types:
      - completed

jobs:
  rollback:
    name: "üß© Rollback Handler"
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: ‚öôÔ∏è Set up job
        run: echo "üîç Initialisation du rollback IA..."

      - name: üß† Checkout repository
        uses: actions/checkout@v4

      - name: üß∞ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üïì Get previous commit
        id: prev
        run: echo "previous_commit=$(git rev-parse HEAD~1)" >> $GITHUB_ENV

      - name: üì• Checkout previous version
        run: git checkout ${{ env.previous_commit }}

      - name: üß© Install dependencies
        run: npm install || echo "‚ö†Ô∏è D√©pendances non critiques ignor√©es."

      - name: üèóÔ∏è Build previous version
        run: npm run build || echo "‚ö†Ô∏è Aucun build √† reconstruire."

      - name: üì¶ Upload rollback artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rollback-package
          path: .

      - name: üöÄ Deploy rollback to Firebase
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          echo "üõ∞Ô∏è D√©ploiement de la version pr√©c√©dente vers Firebase..."
          npx firebase deploy --only hosting --token "$FIREBASE_TOKEN" || {
            echo "‚ùå √âchec du d√©ploiement direct, bascule vers mode secours Cloudflare."
            echo "FAILOVER=1" >> $GITHUB_ENV
          }

      - name: ‚òÅÔ∏è Cloudflare Failover (Emergency)
        if: env.FAILOVER == '1'
        run: |
          echo "üåê Activation Cloudflare Pages (mode secours)..."
          curl -X POST "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/pages/projects/sentinel-fusion/deployments" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"deployment_trigger": {"metadata": {"reason": "Firebase rollback fail ‚Üí Cloudflare takeover"}, "type": "manual"}}'

      - name: ‚úÖ Notify rollback completion
        if: always()
        run: |
          echo "‚úÖ Rollback termin√© √† $(date +"%d/%m/%Y %H:%M")"
          echo "üß† Agent SentinelHealer a v√©rifi√© la stabilit√© du flux"

      - name: üß© Post Commit Log
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "Sentinel Recovery Bot"
          git config user.email "recovery-bot@users.noreply.github.com"
          git pull --rebase
          echo "üß© Rollback du $(date +"%d/%m/%Y %H:%M") ex√©cut√© automatiquement." >> .sentinel_log.txt
          git add .sentinel_log.txt
          git commit -m "‚ôªÔ∏è Auto Rollback ex√©cut√© automatiquement"
          git push