name: ğŸ” Auto Rollback on Failure â€” Sentinel Quantum Vanguard AI Proâ„¢

on:
  workflow_run:
    workflows: ["ğŸš€ Sentinel Quantum Vanguard AI Pro â€” AutoDeploy Cloud Edition"]
    types:
      - completed

  schedule:
    - cron: "0 */2 * * *" # Health-check Cloudflare toutes les 2 h

jobs:
  rollback:
    name: "ğŸ§© Rollback Handler"
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: âš™ï¸ Setup Job
        run: echo "ğŸ” Initialisation du rollback IA..."

      - name: ğŸ§  Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ğŸ•“ Get previous commit
        id: prev
        run: echo "previous_commit=$(git rev-parse HEAD~1)" >> $GITHUB_ENV

      - name: ğŸ“¥ Checkout previous version
        run: git checkout ${{ env.previous_commit }}

      - name: ğŸ§© Install dependencies
        run: npm install || echo "âš ï¸ DÃ©pendances non critiques ignorÃ©es."

      - name: ğŸ—ï¸ Build previous version
        run: npm run build || echo "âš ï¸ Aucun build Ã  reconstruire."

      - name: ğŸ“¦ Upload rollback artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rollback-package
          path: .

      - name: ğŸš€ Deploy rollback to Firebase (fixed)
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          echo "ğŸ›°ï¸ DÃ©ploiement de la version prÃ©cÃ©dente vers Firebase..."
          npm install -g firebase-tools
          firebase use --add sentinel-fusion || true
          firebase deploy --only hosting --token "$FIREBASE_TOKEN" --non-interactive || {
            echo "âŒ Ã‰chec du dÃ©ploiement direct, activation du mode secours Cloudflare."
            echo "FAILOVER=1" >> $GITHUB_ENV
          }

      - name: â˜ï¸ Cloudflare Failover (Emergency)
        if: env.FAILOVER == '1'
        run: |
          echo "ğŸŒ Activation Cloudflare Pages (mode secours)..."
          curl -X POST "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/pages/projects/sentinel-fusion/deployments" \
            -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"deployment_trigger": {"metadata": {"reason": "Firebase rollback fail â†’ Cloudflare takeover"}, "type": "manual"}}'

      - name: ğŸ“¡ Notify rollback completion (GitHub + Email)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATE=$(date +"%d/%m/%Y %H:%M")
          echo "âœ… Rollback terminÃ© Ã  $DATE" >> .sentinel_log.txt
          gh api repos/${{ github.repository }}/issues \
            -f title="ğŸ” Rollback automatique effectuÃ© â€” $DATE" \
            -f body="Le systÃ¨me Sentinel Quantum Vanguard AI Proâ„¢ a dÃ©tectÃ© une erreur de dÃ©ploiement et a restaurÃ© la version stable prÃ©cÃ©dente.\n\nğŸ“… Date : $DATE\nğŸŒ Status : âœ… RestaurÃ©\nâ˜ï¸ Failover : ${FAILOVER:-Aucun}" \
            -f labels="auto-rollback, sentinel-ai" || echo "Notification GitHub ignorÃ©e."

      - name: ğŸ§  Log & Commit Rollback Info
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "Sentinel Recovery Bot"
          git config user.email "recovery-bot@users.noreply.github.com"
          git pull --rebase
          git add .sentinel_log.txt
          git commit -m "â™»ï¸ Auto Rollback exÃ©cutÃ© automatiquement"
          git push

  healthcheck:
    name: "ğŸŒ Cloudflare Health Agent"
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” VÃ©rifier disponibilitÃ© Sentinel
        run: |
          echo "ğŸŒ Test de santÃ© du site Sentinel..."
          STATUS=$(curl -Is https://sentinel-fusion.pages.dev | head -n 1 | grep 200 || true)
          if [ -z "$STATUS" ]; then
            echo "ğŸš¨ Site indisponible â€“ relance du dÃ©ploiement automatique."
            curl -X POST "https://api.cloudflare.com/client/v4/accounts/${{ secrets.CF_ACCOUNT_ID }}/pages/projects/sentinel-fusion/deployments" \
              -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{"deployment_trigger": {"metadata": {"reason": "HealthCheck failure â†’ Redeploy"}, "type": "manual"}}'
          else
            echo "âœ… Site Sentinel opÃ©rationnel."
          fi