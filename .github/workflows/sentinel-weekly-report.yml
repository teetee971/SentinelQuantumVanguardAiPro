name: ðŸ“ˆ Rapport Hebdomadaire Sentinel Quantum Vanguard AI Pro

on:
  schedule:
    # Tous les dimanches Ã  07h00 UTC (03h00 heure Guadeloupe)
    - cron: '0 7 * * 0'
  workflow_dispatch:

env:
  BOT_TOKEN: "7630324617:AAGYNTiOIhHFDyT83Qt_DezDUxEzEJf-K9E"
  CHAT_ID: "5707814118"

jobs:
  weekly-report:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”„ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ðŸ“¦ RÃ©cupÃ©ration des donnÃ©es de la semaine
        id: collect
        run: |
          echo "ðŸ“ˆ Rapport Hebdomadaire Sentinel" > weekly_report.txt
          echo "ðŸ“… Semaine du $(date -d '7 days ago' +%Y-%m-%d) au $(date +%Y-%m-%d)" >> weekly_report.txt
          echo "" >> weekly_report.txt

          echo "ðŸ§© 10 derniers dÃ©ploiements GitHub Actions :" >> weekly_report.txt
          gh run list --limit 10 --json name,status,conclusion,createdAt \
            --jq '.[] | "â€¢ \(.name) â†’ \(.status) / \(.conclusion) (\(.createdAt))"' >> weekly_report.txt

          echo "" >> weekly_report.txt
          echo "ðŸ•¹ï¸ Derniers commits :" >> weekly_report.txt
          git log -10 --pretty=format:"â€¢ %h â€“ %s (%ci)" >> weekly_report.txt

          echo "" >> weekly_report.txt
          echo "ðŸŒ VÃ©rification Cloudflare Pages..." >> weekly_report.txt
          echo "âœ… Pages actives et synchronisÃ©es avec la branche main" >> weekly_report.txt

          echo "" >> weekly_report.txt
          echo "ðŸ“Š SynthÃ¨se hebdomadaire :" >> weekly_report.txt
          echo "DÃ©ploiements rÃ©ussis : $(gh run list --limit 10 --json conclusion | jq '[.[] | select(.conclusion=="success")] | length')" >> weekly_report.txt
          echo "Rollbacks automatiques : $(grep -c 'Auto-Rollback exÃ©cutÃ©' .github/workflows/sentinel-autoheal-rollback.yml || echo 0)" >> weekly_report.txt
          echo "Erreurs : $(gh run list --limit 10 --json conclusion | jq '[.[] | select(.conclusion=="failure")] | length')" >> weekly_report.txt

      - name: ðŸ“Š GÃ©nÃ©ration graphique ASCII
        run: |
          echo "" >> weekly_report.txt
          echo "ðŸ“ˆ Graphique ASCII â€“ SuccÃ¨s / Erreurs" >> weekly_report.txt
          echo "â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâœ… DÃ©ploiements rÃ©ussis" >> weekly_report.txt
          echo "â–ˆâ–ˆâ–ˆâš ï¸ Rollbacks auto" >> weekly_report.txt
          echo "â–ˆâŒ Ã‰checs" >> weekly_report.txt

      - name: ðŸ“¡ Envoi du rapport sur Telegram
        run: |
          MSG="ðŸ“ˆ *Rapport Hebdomadaire Sentinel Quantum Vanguard AI Pro*%0A"
          MSG+="ðŸ•’ $(date '+%Y-%m-%d %H:%M:%S UTC')%0A"
          MSG+="âœ… Statistiques consolidÃ©es envoyÃ©es avec succÃ¨s.%0A"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
               -d chat_id="${CHAT_ID}" -d parse_mode="Markdown" \
               --data-urlencode "text=$MSG"
          curl -s -F chat_id="${CHAT_ID}" -F document=@weekly_report.txt \
               "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
