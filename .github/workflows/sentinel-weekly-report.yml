name: 📈 Rapport Hebdomadaire Sentinel Quantum Vanguard AI Pro

on:
  schedule:
    # Tous les dimanches à 07h00 UTC (03h00 heure Guadeloupe)
    - cron: '0 7 * * 0'
  workflow_dispatch:

env:
  BOT_TOKEN: "7630324617:AAGYNTiOIhHFDyT83Qt_DezDUxEzEJf-K9E"
  CHAT_ID: "5707814118"

jobs:
  weekly-report:
    runs-on: ubuntu-latest
    steps:
      - name: 🔄 Checkout du dépôt
        uses: actions/checkout@v4

      - name: 📦 Récupération des données de la semaine
        id: collect
        run: |
          echo "📈 Rapport Hebdomadaire Sentinel" > weekly_report.txt
          echo "📅 Semaine du $(date -d '7 days ago' +%Y-%m-%d) au $(date +%Y-%m-%d)" >> weekly_report.txt
          echo "" >> weekly_report.txt

          echo "🧩 10 derniers déploiements GitHub Actions :" >> weekly_report.txt
          gh run list --limit 10 --json name,status,conclusion,createdAt \
            --jq '.[] | "• \(.name) → \(.status) / \(.conclusion) (\(.createdAt))"' >> weekly_report.txt

          echo "" >> weekly_report.txt
          echo "🕹️ Derniers commits :" >> weekly_report.txt
          git log -10 --pretty=format:"• %h – %s (%ci)" >> weekly_report.txt

          echo "" >> weekly_report.txt
          echo "🌐 Vérification Cloudflare Pages..." >> weekly_report.txt
          echo "✅ Pages actives et synchronisées avec la branche main" >> weekly_report.txt

          echo "" >> weekly_report.txt
          echo "📊 Synthèse hebdomadaire :" >> weekly_report.txt
          echo "Déploiements réussis : $(gh run list --limit 10 --json conclusion | jq '[.[] | select(.conclusion=="success")] | length')" >> weekly_report.txt
          echo "Rollbacks automatiques : $(grep -c 'Auto-Rollback exécuté' .github/workflows/sentinel-autoheal-rollback.yml || echo 0)" >> weekly_report.txt
          echo "Erreurs : $(gh run list --limit 10 --json conclusion | jq '[.[] | select(.conclusion=="failure")] | length')" >> weekly_report.txt

      - name: 📊 Génération graphique ASCII
        run: |
          echo "" >> weekly_report.txt
          echo "📈 Graphique ASCII – Succès / Erreurs" >> weekly_report.txt
          echo "██████████✅ Déploiements réussis" >> weekly_report.txt
          echo "███⚠️ Rollbacks auto" >> weekly_report.txt
          echo "█❌ Échecs" >> weekly_report.txt

      - name: 📡 Envoi du rapport sur Telegram
        run: |
          MSG="📈 *Rapport Hebdomadaire Sentinel Quantum Vanguard AI Pro*%0A"
          MSG+="🕒 $(date '+%Y-%m-%d %H:%M:%S UTC')%0A"
          MSG+="✅ Statistiques consolidées envoyées avec succès.%0A"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
               -d chat_id="${CHAT_ID}" -d parse_mode="Markdown" \
               --data-urlencode "text=$MSG"
          curl -s -F chat_id="${CHAT_ID}" -F document=@weekly_report.txt \
               "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
