name: Monthly Usage Reset

# Runs on the 1st of every month at 00:00 UTC
# Resets usage counters for all users
on:
  schedule:
    # Cron format: minute hour day month day-of-week
    # Runs at 00:00 UTC on the 1st day of every month
    - cron: '0 0 1 * *'
  
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  reset-usage:
    runs-on: ubuntu-latest
    name: Reset Monthly Usage Counters
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Run usage reset script
        working-directory: ./backend
        env:
          API_URL: ${{ secrets.API_URL || 'http://localhost:3333' }}
          API_KEY: ${{ secrets.USAGE_RESET_API_KEY }}
        run: node scripts/reset-usage.js
      
      - name: Send notification
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}'
            const message = status === 'success' 
              ? '‚úÖ Monthly usage reset completed successfully'
              : '‚ùå Monthly usage reset failed'
            
            console.log(message)
            
            // Optional: Send to monitoring/alerting system
            // await fetch('YOUR_WEBHOOK_URL', {
            //   method: 'POST',
            //   body: JSON.stringify({ message, status })
            // })
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Monthly Usage Reset Failed',
              body: `The monthly usage reset job failed on ${new Date().toISOString()}.
              
              Please investigate and run the reset manually if needed.
              
              Workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['bug', 'usage-metering', 'high-priority']
            })
