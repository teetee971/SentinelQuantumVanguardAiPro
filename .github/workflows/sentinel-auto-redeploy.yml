name: üîÅ Sentinel ‚Äì Auto Redeploy (every 30 min)

on:
  schedule:
    - cron: "*/30 * * * *"
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üîÑ Checkout
        uses: actions/checkout@v4

      - name: üß© Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: üì¶ Install deps (ci)
        run: npm ci

      - name: ‚öôÔ∏è Build (prod + logs)
        run: |
          echo "üöÄ Build Sentinel v3.3 (prod + debug logs)"
          npm run build || echo "‚ö†Ô∏è Build termin√© avec avertissements (Service Worker ignor√© si non support√©)"

      - name: üåê Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: "sentinelquantumvanguardaipro"
          directory: "dist"
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚úÖ Healthcheck summary
        if: always()
        run: |
          echo "Site: https://sentinelquantumvanguardaipro.pages.dev"
          echo "Docs: https://sentinelquantumvanguardaipro.pages.dev/documentation/"
          echo "3D  : https://sentinelquantumvanguardaipro.pages.dev/architecture3d.html"

      - name: üì° Telegram notify (optional)
        if: always()
        run: |
          if [ -n "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] && [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            MSG="üîÅ Sentinel auto-redeploy OK (30 min cadence)\nüåê Site: https://sentinelquantumvanguardaipro.pages.dev"
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" -d text="$MSG" >/dev/null
          else
            echo "‚ÑπÔ∏è Telegram d√©sactiv√© (secrets manquants)."
          fi
