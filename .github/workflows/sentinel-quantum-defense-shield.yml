name: ğŸ›¡ï¸ Sentinel Quantum Defense Shield

on:
  workflow_run:
    workflows: ["ğŸ›¡ï¸ Sentinel Threat Intelligence Nexus"]
    types: [completed]
  schedule:
    - cron: '30 */6 * * *' # toutes les 6 h 30
  workflow_dispatch:

jobs:
  quantum_defense:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ğŸ§  Lecture des alertes du Threat Nexus
        run: |
          mkdir -p defense
          if [ -f threats/abuseipdb.json ]; then
            jq -r '.data[0:10] | .[].ipAddress' threats/abuseipdb.json > defense/suspect_ips.txt
          else
            echo "Aucune donnÃ©e Threat Nexus trouvÃ©e" > defense/suspect_ips.txt
          fi
          echo "ğŸ“¡ IP suspectes listÃ©es :"
          cat defense/suspect_ips.txt || true

      - name: âš™ï¸ Application des contre-mesures
        run: |
          mkdir -p defense
          echo "ğŸ›¡ï¸ Application des rÃ¨gles adaptatives..." > defense/actions.log
          COUNT=$(wc -l < defense/suspect_ips.txt)
          if [ "$COUNT" -gt 0 ]; then
            while read -r ip; do
              echo "â›” Blocage de ${ip}" >> defense/actions.log
              echo "POST https://api.cloudflare.com/client/v4/accounts/${{ secrets.CLOUDFLARE_ACCOUNT_ID }}/firewall/access_rules/rules {\"mode\":\"block\",\"configuration\":{\"target\":\"ip\",\"value\":\"$ip\"},\"notes\":\"Auto-block Sentinel\"}" >> defense/actions.log
            done < defense/suspect_ips.txt
          else
            echo "âœ… Aucune IP malveillante dÃ©tectÃ©e." >> defense/actions.log
          fi
          echo "ğŸ’¾ Actions consignÃ©es le $(date)" >> defense/actions.log

      - name: ğŸ§¾ GÃ©nÃ©ration du rapport HTML
        run: |
          mkdir -p public/defense
          echo "<html><head><title>Sentinel Quantum Defense Shield</title><meta http-equiv='refresh' content='21600'></head><body style='background:#0d1117;color:#e6edf3;font-family:monospace;padding:20px;'>" > public/defense/index.html
          echo "<h2>ğŸ›¡ï¸ Sentinel Quantum Defense Shield</h2><hr>" >> public/defense/index.html
          echo "<h3>ğŸš« IP dÃ©tectÃ©es</h3><pre>" >> public/defense/index.html
          cat defense/suspect_ips.txt >> public/defense/index.html || echo "Aucune" >> public/defense/index.html
          echo "</pre><h3>âš™ï¸ Actions effectuÃ©es</h3><pre>" >> public/defense/index.html
          cat defense/actions.log >> public/defense/index.html
          echo "</pre><hr><p>ğŸ•’ DerniÃ¨re mise Ã  jour : $(date)</p></body></html>" >> public/defense/index.html
          echo "âœ… Rapport Defense Shield gÃ©nÃ©rÃ©."

      - name: ğŸš€ Publication sur Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: sentinelquantumvanguardaipro
          directory: public
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¡ Alerte Telegram
        run: |
          BLOCKS=$(wc -l < defense/suspect_ips.txt)
          MSG="ğŸ›¡ï¸ Sentinel Quantum Defense Shield\nIP bloquÃ©es : ${BLOCKS}\nLien : https://sentinelquantumvanguardaipro.pages.dev/defense/\nğŸ•’ $(date)"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
               -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
               -d text="$MSG"

      - name: âœ… Fin du cycle Defense Shield
        run: echo "âœ”ï¸ Sentinel Quantum Defense Shield terminÃ© avec succÃ¨s."