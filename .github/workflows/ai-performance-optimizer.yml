name: âš™ï¸ AI Performance Optimizer

on:
  schedule:
    - cron: "*/30 * * * *"   # toutes les 30 minutes
  workflow_dispatch:

jobs:
  optimize:
    runs-on: ubuntu-latest
    steps:
      - name: âš™ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¡ Analyse de performance Cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          echo "ğŸŒ VÃ©rification Cloudflare CDN..."
          START=$(date +%s)
          curl -s -o /dev/null -w "%{time_total}" https://sentinelquantumvanguardaipro.pages.dev > latency.txt
          LATENCY=$(cat latency.txt)
          echo "âš™ï¸ Latence actuelle : ${LATENCY}s"
          if (( $(echo "$LATENCY > 2.0" | bc -l) )); then
            echo "âš ï¸ Latence trop Ã©levÃ©e â†’ purge cache Cloudflare"
            curl -s -X POST "https://api.cloudflare.com/client/v4/zones/$CLOUDFLARE_ZONE_ID/purge_cache" \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json" \
              --data '{"purge_everything":true}'
          fi
          END=$(date +%s)
          echo "â± Temps total dâ€™exÃ©cution : $((END-START))s"

      - name: ğŸ”¬ VÃ©rification de lâ€™usage CPU et mÃ©moire
        run: |
          echo "ğŸ§  Mesure locale..."
          CPU=$(top -bn1 | grep "Cpu(s)" | awk '{print $2 + $4}')
          MEM=$(free -m | awk '/Mem:/ {print $3 "/" $2 " MB (" $3/$2*100 "%)"}')
          echo "ğŸ§© CPU: ${CPU}%  |  RAM: ${MEM}"

      - name: ğŸ§® Ajustement automatique des frÃ©quences
        run: |
          echo "ğŸ“Š Lecture du rapport prÃ©cÃ©dent..."
          LATENCY=$(cat latency.txt)
          echo "ğŸ“ˆ Adaptation dynamique..."
          if (( $(echo "$LATENCY > 3.0" | bc -l) )); then
            echo "âš ï¸ RÃ©duction des dÃ©clenchements Ã  toutes les 45 min"
            sed -i 's|*/30|*/45|' .github/workflows/ai-performance-optimizer.yml || true
          else
            echo "âœ… Latence stable â€” maintien Ã  30 min"
          fi

      - name: ğŸ’¾ GÃ©nÃ©ration dâ€™un rapport de performance
        run: |
          mkdir -p logs
          echo "ğŸ•’ $(date -u)" > logs/perf-report.txt
          echo "âš™ï¸ Latence: ${LATENCY}s" >> logs/perf-report.txt
          echo "ğŸ§  CPU: ${CPU}%" >> logs/perf-report.txt
          echo "ğŸ’¾ MÃ©moire: ${MEM}" >> logs/perf-report.txt

      - name: ğŸ“¤ Commit automatique du rapport
        run: |
          git config --global user.name "SentinelAI-Autobot"
          git config --global user.email "autobot@sentinel.ai"
          git add logs/perf-report.txt || true
          git commit -m "ğŸ“Š Update AI performance report ($(date -u '+%H:%M'))" || echo "Pas de changement"
          git push || true

      - name: ğŸ“² Notification Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MSG="âš™ï¸ *AI Performance Optimizer*\nğŸ•’ $(date -u '+%Y-%m-%d %H:%M:%S') UTC\nâš™ï¸ Latence: ${LATENCY}s\nğŸ§  CPU: ${CPU}%\nğŸ’¾ MÃ©moire: ${MEM}\nğŸŒ [Sentinel Vanguard AI Pro](https://sentinelquantumvanguardaipro.pages.dev)"
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TELEGRAM_CHAT_ID" \
            -d "text=$MSG" \
            -d "parse_mode=Markdown"
