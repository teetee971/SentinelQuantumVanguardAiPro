name: "üö® Sentinel Alert Sync ‚Äî Firestore & Dashboard"

on:
  workflow_run:
    workflows: ["üì¢ Sentinel Live Alerts ‚Äî Telegram on Failure"]
    types: [completed]
  workflow_dispatch:

jobs:
  firestore-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: üß∞ Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: üîê Variables d'environnement
        id: vars
        run: |
          echo "FIREBASE_PROJECT=sentinel" >> $GITHUB_OUTPUT

      - name: ‚öôÔ∏è Installation des outils Firebase
        run: |
          npm install -g firebase-tools
          npm install firebase-admin
          echo "${{ secrets.FIRESTORE_SERVICE_KEY }}" > service.json
          chmod 600 service.json

      - name: üîé Lecture des incidents r√©cents
        run: |
          if [ ! -f status/current.json ]; then
            echo "‚ùå Aucun status/current.json d√©tect√©, arr√™t."
            exit 0
          fi
          jq -c '.[] | select(.status=="red")' status/current.json > alerts.ndjson || true

      - name: üöÄ Synchronisation Firestore
        run: |
          if [ ! -s alerts.ndjson ]; then
            echo "‚úÖ Aucun nouvel incident √† synchroniser."
            exit 0
          fi

          node <<'NODE'
          const fs = require('fs');
          const admin = require('firebase-admin');
          const service = JSON.parse(fs.readFileSync('service.json','utf8'));
          admin.initializeApp({ credential: admin.credential.cert(service) });
          const db = admin.firestore();
          const alerts = fs.readFileSync('alerts.ndjson','utf8').trim().split('\n').filter(line => line.trim()).map(JSON.parse);

          (async () => {
            try {
              for (const a of alerts) {
                const ref = db.collection('sentinel_alerts').doc(`${a.module}-${a.timestamp}`);
                await ref.set({
                  module: a.module,
                  url: a.url,
                  http: a.http,
                  status: a.status,
                  timestamp: a.timestamp,
                  acknowledged: false,
                  source: "Sentinel",
                }, { merge: true });
                console.log(`üì° Incident ${a.module} enregistr√©.`);
              }
              process.exit(0);
            } catch (error) {
              console.error('‚ùå Erreur:', error.message);
              process.exit(1);
            }
          })();
          NODE
