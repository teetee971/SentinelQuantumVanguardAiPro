name: ðŸ“Š Rapport Quotidien Sentinel Quantum Vanguard AI Pro

on:
  schedule:
    # Envoie le rapport chaque jour Ã  07h00 UTC (03h00 Guadeloupe)
    - cron: '0 7 * * *'
  workflow_dispatch:

env:
  BOT_TOKEN: "7630324617:AAGYNTiOIhHFDyT83Qt_DezDUxEzEJf-K9E"
  CHAT_ID: "5707814118"

jobs:
  daily-report:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”„ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“Š GÃ©nÃ©ration du rapport
        id: report
        run: |
          echo "ðŸ§  Rapport quotidien Sentinel" > report.txt
          echo "ðŸ“… Date : $(date '+%Y-%m-%d %H:%M:%S UTC')" >> report.txt
          echo "" >> report.txt
          echo "ðŸ§© Historique des 5 derniers dÃ©ploiements :" >> report.txt
          gh run list --limit 5 --json name,status,conclusion,createdAt \
            --jq '.[] | "â€¢ \(.name) â†’ \(.status) / \(.conclusion) (\(.createdAt))"' >> report.txt

          echo "" >> report.txt
          echo "ðŸ•¹ï¸ Derniers commits :" >> report.txt
          git log -5 --pretty=format:"â€¢ %h â€“ %s (%ci)" >> report.txt

          echo "" >> report.txt
          echo "ðŸ“¦ Uptime Cloudflare Pages :" >> report.txt
          echo "âœ… En ligne (status check effectuÃ© Ã  $(date '+%H:%M UTC'))" >> report.txt

      - name: ðŸ“¡ Envoi du rapport sur Telegram
        run: |
          MSG="ðŸ“Š *Rapport Quotidien Sentinel Quantum Vanguard AI Pro*%0A"
          MSG+="ðŸ•’ $(date '+%Y-%m-%d %H:%M:%S UTC')%0A"
          MSG+="âœ… Builds rÃ©cents et Ã©tat Cloudflare collectÃ©s avec succÃ¨s.%0A"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
               -d chat_id="${CHAT_ID}" -d parse_mode="Markdown" \
               --data-urlencode "text=$MSG"
          curl -s -F chat_id="${CHAT_ID}" -F document=@report.txt \
               "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
