name: 📊 Rapport Quotidien Sentinel Quantum Vanguard AI Pro

on:
  schedule:
    # Envoie le rapport chaque jour à 07h00 UTC (03h00 Guadeloupe)
    - cron: '0 7 * * *'
  workflow_dispatch:

env:
  BOT_TOKEN: "7630324617:AAGYNTiOIhHFDyT83Qt_DezDUxEzEJf-K9E"
  CHAT_ID: "5707814118"

jobs:
  daily-report:
    runs-on: ubuntu-latest
    steps:
      - name: 🔄 Checkout
        uses: actions/checkout@v4

      - name: 📊 Génération du rapport
        id: report
        run: |
          echo "🧠 Rapport quotidien Sentinel" > report.txt
          echo "📅 Date : $(date '+%Y-%m-%d %H:%M:%S UTC')" >> report.txt
          echo "" >> report.txt
          echo "🧩 Historique des 5 derniers déploiements :" >> report.txt
          gh run list --limit 5 --json name,status,conclusion,createdAt \
            --jq '.[] | "• \(.name) → \(.status) / \(.conclusion) (\(.createdAt))"' >> report.txt

          echo "" >> report.txt
          echo "🕹️ Derniers commits :" >> report.txt
          git log -5 --pretty=format:"• %h – %s (%ci)" >> report.txt

          echo "" >> report.txt
          echo "📦 Uptime Cloudflare Pages :" >> report.txt
          echo "✅ En ligne (status check effectué à $(date '+%H:%M UTC'))" >> report.txt

      - name: 📡 Envoi du rapport sur Telegram
        run: |
          MSG="📊 *Rapport Quotidien Sentinel Quantum Vanguard AI Pro*%0A"
          MSG+="🕒 $(date '+%Y-%m-%d %H:%M:%S UTC')%0A"
          MSG+="✅ Builds récents et état Cloudflare collectés avec succès.%0A"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
               -d chat_id="${CHAT_ID}" -d parse_mode="Markdown" \
               --data-urlencode "text=$MSG"
          curl -s -F chat_id="${CHAT_ID}" -F document=@report.txt \
               "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
