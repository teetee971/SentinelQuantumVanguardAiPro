name: üß† Sentinel Auto-Recovery

on:
  workflow_run:
    workflows:
      - "üåå Sentinel Nightly Health Monitor"
      - "üß© Sentinel Auto-Healer"
      - "üõ∞ Sentinel Telemetry Watcher"
      - "üöÄ Publish Sentinel Dashboard to Cloudflare Pages"
    types:
      - completed
  workflow_dispatch:

jobs:
  recovery:
    runs-on: ubuntu-latest

    steps:
      - name: üîç V√©rification des workflows r√©cents
        uses: actions/github-script@v7
        id: check
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 10
            });
            const failed = runs.workflow_runs.find(r => r.conclusion === "failure");
            if (failed) {
              core.setOutput("failed_workflow_id", failed.id);
              core.notice(`‚ùå Workflow √©chou√© d√©tect√© : ${failed.name}`);
            } else {
              core.notice("‚úÖ Aucun workflow √©chou√© r√©cemment.");
            }

      - name: üöÄ Relancer automatiquement le dernier workflow √©chou√©
        if: steps.check.outputs.failed_workflow_id
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.reRunWorkflow({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{ steps.check.outputs.failed_workflow_id }}
            });
            core.notice("ü©π Workflow √©chou√© relanc√© automatiquement avec succ√®s.");

      - name: üì° Notification Telegram
        run: |
          MSG="üß† Sentinel Auto-Recovery ex√©cut√©.\n"
          if [ -n "${{ steps.check.outputs.failed_workflow_id }}" ]; then
            MSG="${MSG}üîÅ Un workflow a √©t√© relanc√© automatiquement."
          else
            MSG="${MSG}‚úÖ Aucun √©chec d√©tect√©."
          fi
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MSG\nüïí $(date)"

      - name: ‚úÖ Fin du cycle Auto-Recovery
        run: echo "‚úîÔ∏è Sentinel Auto-Recovery termin√© avec succ√®s."