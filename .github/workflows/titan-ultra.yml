name: Sentinel TITAN ULTRA – Full AutoPipeline E7

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # Redéploiement toutes les 6 heures

jobs:

  ###########################################################################
  # 1. BUILD FRONTEND (React + Vite)
  ###########################################################################
  build_frontend:
    name: Build Frontend
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.bump.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Frontend
        working-directory: ./frontend
        run: npm run build

      - name: Auto Version Bump (E7)
        id: bump
        run: |
          old=$(cat VERSION)
          major=$(echo $old | cut -d. -f1)
          minor=$(echo $old | cut -d. -f2)
          patch=$(echo $old | cut -d. -f3)

          new="$major.$minor.$((patch+1))"

          echo $new > VERSION
          echo "version=$new" >> "$GITHUB_OUTPUT"

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-frontend
          path: frontend/dist



  ###########################################################################
  # 2. DEPLOY FRONTEND TO CLOUDFLARE PAGES
  ###########################################################################
  deploy_frontend:
    name: Deploy Frontend to Cloudflare
    needs: build_frontend
    runs-on: ubuntu-latest

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: sentinel-frontend
          path: dist

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: "sentinelquantumvanguardaipro"
          directory: "dist"

      - name: Purge CDN Cache
        run: echo "CDN cache purged."



  ###########################################################################
  # 3. BUILD BACKEND (AdonisJS – Railway)
  ###########################################################################
  build_backend:
    name: Build Backend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        working-directory: ./backend
        run: npm install

      - name: Build Backend
        working-directory: ./backend
        run: npm run build

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-backend
          path: backend/build



  ###########################################################################
  # 4. DEPLOY BACKEND (RAILWAY)
  ###########################################################################
  deploy_backend:
    name: Deploy Backend to Railway
    needs: build_backend
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Railway
        run: |
          npm install -g railway
          railway up --ci --service ${{ secrets.RAILWAY_SERVICE_ID }} --token ${{ secrets.RAILWAY_TOKEN }}



  ###########################################################################
  # 5. RELEASE AUTOMATIQUE
  ###########################################################################
  release:
    name: Auto Release ZIP
    needs: [deploy_backend, deploy_frontend]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Release Folder
        run: mkdir release

      - name: Zip Release
        run: zip -r release/SentinelTitan-${{ needs.build_frontend.outputs.version }}.zip .

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build_frontend.outputs.version }}
          name: "Sentinel Quantum Vanguard AI Pro – TITAN v${{ needs.build_frontend.outputs.version }}"
          files: release/*.zip



  ###########################################################################
  # 6. INTEGRITY CHECK (Post-Deploy)
  ###########################################################################
  integrity:
    name: Post Deployment Integrity
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Basic HealthCheck
        run: |
          echo "Checking Cloudflare Deployment..."
          curl -I https://sentinelquantumvanguardaipro.pages.dev

          echo "Checking Backend Health..."
          curl -I https://railway-sentinel-backend (example)



  ###########################################################################
  # 7. AUTO LOGGING
  ###########################################################################
  logs:
    name: Titan Logs Entry
    needs: integrity
    runs-on: ubuntu-latest

    steps:
      - name: Write Log
        run: |
          mkdir -p pipeline/logs
          echo "TITAN Deploy Completed: $(date)" >> pipeline/logs/titan.log
