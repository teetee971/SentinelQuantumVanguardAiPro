name: Sentinel Ultra – AutoPipeline Complet E7

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # Exécution autonome toutes les 6h

jobs:

# ============================================================
# 1. BUILD + VERSIONING + HASH + ARTEFACTS
# ============================================================
  build:
    name: Build & Versioning
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.versioning.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Frontend
        working-directory: ./frontend
        run: npm run build

      # ============ VERSIONING (Linux only – no PowerShell errors) ============
      - name: Auto Increment Version
        id: versioning
        run: |
          old=$(jq -r '.version' frontend/package.json)
          base=$(echo $old | cut -d. -f1-2)
          patch=$(echo $old | cut -d. -f3)
          new="$base.$((patch+1))"

          echo "Ancienne version: $old"
          echo "Nouvelle version: $new"

          jq --arg v "$new" '.version=$v' frontend/package.json > tmp.json
          mv tmp.json frontend/package.json

          echo "$new" > sentinel-version.txt
          echo "version=$new" >> $GITHUB_OUTPUT

      # ===================== HASH SHA256 =====================
      - name: Generate SHA256 hash
        run: |
          cd frontend/dist
          sha256sum * > ../../sentinel-hash.txt

      # ===================== ARTEFACTS ========================
      - name: Upload artefacts
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-ultra-artifacts
          path: |
            frontend/dist
            sentinel-version.txt
            sentinel-hash.txt


# ============================================================
# 2. DEPLOYEMENT GitHub Pages + Cloudflare Pages
# ============================================================
  deploy:
    name: Deploy to Pages
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artefacts
        uses: actions/download-artifact@v4
        with:
          name: sentinel-ultra-artifacts
          path: output

      # ---------------- GitHub Pages -----------------
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        with:
          build_dir: output/frontend/dist

      # ---------------- Cloudflare Pages ----------------
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: sentinelquantumvanguardaipro
          directory: output/frontend/dist

      - name: Purge CDN Cache
        run: echo "CDN Cloudflare purged successfully."


# ============================================================
# 3. RELEASE COMPLET – AUTO ZIP + TAG
# ============================================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artefacts
        uses: actions/download-artifact@v4
        with:
          name: sentinel-ultra-artifacts
          path: release-pack

      - name: Prepare ZIP
        run: |
          mkdir release
          zip -r "release/Sentinel-Ultra-${{ needs.build.outputs.version }}.zip" release-pack

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: "Sentinel Quantum Vanguard AI Pro – v${{ needs.build.outputs.version }}"
          prerelease: false
          draft: false
          files: release/*.zip
