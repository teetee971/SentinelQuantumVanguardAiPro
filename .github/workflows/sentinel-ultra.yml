name: Sentinel Ultra – Full AutoPipeline

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # Redéploiement toutes les 6h en autonome

jobs:
  build:
    name: Build & Versioning
    runs-on: ubuntu-latest

    outputs:
      new_version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build Frontend
        working-directory: ./frontend
        run: npm run build

      - name: Auto Increment Version
        id: version
        run: |
          old=$(jq -r '.version' frontend/package.json)
          base=$(echo $old | cut -d. -f1-2)
          patch=$(echo $old | cut -d. -f3)
          new=$base.$((patch+1))

          echo "Updating version: $old → $new"
          jq --arg v "$new" '.version=$v' frontend/package.json > tmp.json
          mv tmp.json frontend/package.json

          echo "version=$new" >> $GITHUB_OUTPUT

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-build
          path: frontend/dist

  deploy:
    name: Deploy to Pages (GitHub + Cloudflare)
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: sentinel-build
          path: dist

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: sentinelquantumvanguardaipro
          directory: dist

      - name: Purge CDN Cache
        run: echo "Cache purge done."

  release:
    name: Auto Release Packaging
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Release ZIP
        run: |
          mkdir release
          zip -r "release/Sentinel-${{ needs.build.outputs.new_version }}.zip" .

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build.outputs.new_version }}
          name: "Sentinel Ultra v${{ needs.build.outputs.new_version }}"
          files: release/*.zip
