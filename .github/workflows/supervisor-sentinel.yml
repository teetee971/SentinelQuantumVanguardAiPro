name: 🧠 SentinelAI Supervisor

on:
  schedule:
    - cron: "*/20 * * * *"   # vérifie toutes les 20 minutes
  workflow_dispatch:

jobs:
  supervise:
    runs-on: ubuntu-latest
    steps:
      - name: ⚙️ Checkout Repository
        uses: actions/checkout@v4

      - name: 🧩 Vérification de l’état des agents IA
        run: |
          echo "🔍 Analyse du réseau Sentinel..."
          AGENTS=("AutoSelfHeal" "Watchdog AI Sentinel" "Telegram LiveMonitor" "Telegram AlertOnFailure" "SmartCachePurge" "HealthAgent")
          for AGENT in "${AGENTS[@]}"; do
            echo "🧠 Vérifie $AGENT ..."
            STATUS=$(gh run list --workflow "$AGENT" --limit 1 --json conclusion | jq -r '.[0].conclusion' || echo "unknown")
            if [ "$STATUS" != "success" ]; then
              echo "⚠️ $AGENT inactif ou échoué — tentative de redéploiement..."
              gh workflow run "$AGENT" || echo "⚠️ Impossible de relancer $AGENT (peut-être inactif ou renommé)"
            else
              echo "✅ $AGENT opérationnel"
            fi
          done

      - name: 🔁 Synchronisation auto des workflows
        run: |
          echo "🔄 Synchronisation du réseau IA Sentinel..."
          git fetch origin main
          git reset --hard origin/main || true

      - name: 🌐 Vérification du site Sentinel
        run: |
          echo "🌍 Vérification de la disponibilité du site..."
          curl -s -o /dev/null -w "%{http_code}" https://sentinelquantumvanguardaipro.pages.dev | grep -q 200 && \
          echo "✅ Site en ligne" || echo "❌ Erreur d’accès au site"

      - name: 🧠 Auto-déclenchement d’AutoSelfHeal si problème détecté
        run: |
          STATUS=$(curl -s https://sentinelquantumvanguardaipro.pages.dev/health.json | jq -r .status 2>/dev/null || echo "unknown")
          if [ "$STATUS" != "ok" ]; then
            echo "🚨 Status = $STATUS → lancement AutoSelfHeal..."
            gh workflow run "♻️ AutoSelfHeal (Sentinel Recovery)" || echo "⚠️ Échec du déclenchement d'AutoSelfHeal"
          else
            echo "✅ Health OK : pas d’action requise"
          fi

      - name: 📡 Rapport Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MSG="🧠 *SentinelAI Supervisor*\n🕒 $(date -u '+%Y-%m-%dT%H:%M:%SZ')\n✅ Surveillance complète effectuée\n🌐 [Ouvrir Sentinel](https://sentinelquantumvanguardaipro.pages.dev)"
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d "chat_id=$TELEGRAM_CHAT_ID" \
          -d "text=$MSG" \
          -d "parse_mode=Markdown"
