name: ğŸ§  SentinelAI Supervisor

on:
  schedule:
    - cron: "*/20 * * * *"   # vÃ©rifie toutes les 20 minutes
  workflow_dispatch:

jobs:
  supervise:
    runs-on: ubuntu-latest
    steps:
      - name: âš™ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§© VÃ©rification de lâ€™Ã©tat des agents IA
        run: |
          echo "ğŸ” Analyse du rÃ©seau Sentinel..."
          AGENTS=("AutoSelfHeal" "Watchdog AI Sentinel" "Telegram LiveMonitor" "Telegram AlertOnFailure" "SmartCachePurge" "HealthAgent")
          for AGENT in "${AGENTS[@]}"; do
            echo "ğŸ§  VÃ©rifie $AGENT ..."
            STATUS=$(gh run list --workflow "$AGENT" --limit 1 --json conclusion | jq -r '.[0].conclusion' || echo "unknown")
            if [ "$STATUS" != "success" ]; then
              echo "âš ï¸ $AGENT inactif ou Ã©chouÃ© â€” tentative de redÃ©ploiement..."
              gh workflow run "$AGENT" || echo "âš ï¸ Impossible de relancer $AGENT (peut-Ãªtre inactif ou renommÃ©)"
            else
              echo "âœ… $AGENT opÃ©rationnel"
            fi
          done

      - name: ğŸ” Synchronisation auto des workflows
        run: |
          echo "ğŸ”„ Synchronisation du rÃ©seau IA Sentinel..."
          git fetch origin main
          git reset --hard origin/main || true

      - name: ğŸŒ VÃ©rification du site Sentinel
        run: |
          echo "ğŸŒ VÃ©rification de la disponibilitÃ© du site..."
          curl -s -o /dev/null -w "%{http_code}" https://sentinelquantumvanguardaipro.pages.dev | grep -q 200 && \
          echo "âœ… Site en ligne" || echo "âŒ Erreur dâ€™accÃ¨s au site"

      - name: ğŸ§  Auto-dÃ©clenchement dâ€™AutoSelfHeal si problÃ¨me dÃ©tectÃ©
        run: |
          STATUS=$(curl -s https://sentinelquantumvanguardaipro.pages.dev/health.json | jq -r .status 2>/dev/null || echo "unknown")
          if [ "$STATUS" != "ok" ]; then
            echo "ğŸš¨ Status = $STATUS â†’ lancement AutoSelfHeal..."
            gh workflow run "â™»ï¸ AutoSelfHeal (Sentinel Recovery)" || echo "âš ï¸ Ã‰chec du dÃ©clenchement d'AutoSelfHeal"
          else
            echo "âœ… Health OK : pas dâ€™action requise"
          fi

      - name: ğŸ“¡ Rapport Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MSG="ğŸ§  *SentinelAI Supervisor*\nğŸ•’ $(date -u '+%Y-%m-%dT%H:%M:%SZ')\nâœ… Surveillance complÃ¨te effectuÃ©e\nğŸŒ [Ouvrir Sentinel](https://sentinelquantumvanguardaipro.pages.dev)"
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d "chat_id=$TELEGRAM_CHAT_ID" \
          -d "text=$MSG" \
          -d "parse_mode=Markdown"
