name: ğŸ§© Wave 28 â€“ Sentinel Quantum Sentience Node (Contextual Awareness Core)

on:
  schedule:
    - cron: "0 */3 * * *"     # toutes les 3h
  workflow_dispatch:

jobs:
  sentience:
    runs-on: ubuntu-latest
    name: ğŸ§  Quantum Sentience Core
    steps:
      - name: ğŸš€ Initialisation
        run: |
          echo "ğŸ§© Lancement Quantum Sentience Node"
          mkdir -p logs sentience
          echo "$(date '+%F %T') | DÃ©but Wave 28" >> logs/sentience.log

      - name: ğŸ“¡ Lecture des Ã©tats prÃ©cÃ©dents
        run: |
          cp public/telemetry/neural_state.json sentience/neural.json 2>/dev/null || echo '{}' > sentience/neural.json
          cp public/telemetry/adaptive_model.json sentience/adaptive.json 2>/dev/null || echo '{}' > sentience/adaptive.json
          cp public/telemetry/predictive_forecast.json sentience/predictive.json 2>/dev/null || echo '{}' > sentience/predictive.json
          cp public/telemetry/remediation_report.json sentience/repair.json 2>/dev/null || echo '{}' > sentience/repair.json

      - name: ğŸ§¬ GÃ©nÃ©ration du rapport de cohÃ©rence
        run: |
          jq -n --slurpfile n sentience/neural.json \
                --slurpfile a sentience/adaptive.json \
                --slurpfile p sentience/predictive.json \
                --slurpfile r sentience/repair.json '
          {
            timestamp: now,
            meta: {
              total_nodes: ($n[0].nodes|length),
              stable_nodes: ([.n[0].nodes[]? | select(.health=="stable")] | length),
              avg_score: ([$a[0].nodes[]?.score] | add / (length + 0.1))
            },
            risk: ($p[0].global_risk // "Unknown"),
            last_actions: ($r[0].actions // []),
            global_state: (if ($p[0].global_risk == "High") then "âš ï¸ surveillance requise"
                           else "âœ… systÃ¨me nominal" end),
            commentary: "Ce rapport agrÃ¨ge la Neural Fabric, lâ€™Adaptive Loop et le Predictive Core pour produire une conscience de systÃ¨me : une vue cohÃ©rente du rÃ©seau Sentinel et de sa stabilitÃ© opÃ©rationnelle."
          }' > public/telemetry/quantum_sentience_report.json
          echo "âœ… Rapport JSON gÃ©nÃ©rÃ©" >> logs/sentience.log

      - name: ğŸ§¾ GÃ©nÃ©ration du rÃ©sumÃ© Markdown
        run: |
          jq -r '
            "# Sentinel Quantum Sentience Node\n\n" +
            "Horodatage : " + (.timestamp|tostring) + "\n\n" +
            "## Ã‰tat global : " + .global_state + "\n\n" +
            "- NÅ“uds totaux : " + (.meta.total_nodes|tostring) + "\n" +
            "- NÅ“uds stables : " + (.meta.stable_nodes|tostring) + "\n" +
            "- Score moyen : " + (.meta.avg_score|tostring) + "\n" +
            "- Risque global : " + .risk + "\n\n" +
            "### DerniÃ¨res actions correctives\n" +
            (.last_actions|map("- " + (.wave // "indÃ©fini"))|join("\n")) + "\n\n" +
            "### Commentaire :\n" + .commentary + "\n"
          ' public/telemetry/quantum_sentience_report.json > public/telemetry/quantum_sentience.md
          echo "âœ… Rapport Markdown gÃ©nÃ©rÃ©" >> logs/sentience.log

      - name: ğŸ’¾ Commit
        run: |
          git config --global user.name "Sentinel-Sentience"
          git config --global user.email "sentience@sentinel"
          git add public/telemetry/quantum_sentience_report.json public/telemetry/quantum_sentience.md
          git commit -m "ğŸ§© Update Quantum Sentience Report $(date +%T)" || echo "Aucune modification"
          git push || echo "Push non nÃ©cessaire"

      - name: ğŸ“² Notification Telegram
        if: always()
        run: |
          if [ -n "${{ secrets.TELEGRAM_WEBHOOK }}" ]; then
            MSG="ğŸ§  [Quantum Sentience Node] Rapport de cohÃ©rence mis Ã  jour âœ…"
            curl -s -X POST ${{ secrets.TELEGRAM_WEBHOOK }} -d "text=$MSG"
          fi

      - name: ğŸ—‚ï¸ Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-quantum-sentience-logs
          path: logs/
