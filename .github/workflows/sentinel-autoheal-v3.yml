name: â™»ï¸ Sentinel Quantum Auto-Heal v3 â€“ Recovery & Rollback IA

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *" # VÃ©rifie toutes les 30 minutes
  workflow_run:
    workflows: ["ğŸš¨ Sentinel Critical Alerts â€“ IA Surveillance Continue"]
    types: [completed]

env:
  BOT_TOKEN: "7630324617:AAGYNTiOIhHFDyT83Qt_DezDUxEzEJf-K9E"
  CHAT_ID: "5707814118"
  CLOUDFLARE_URL: "https://sentinelquantumvanguardaipro.pages.dev"

jobs:
  autoheal:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ“¡ VÃ©rification Cloudflare
        id: check
        run: |
          STATUS=$(curl -Is $CLOUDFLARE_URL | head -1 | awk '{print $2}')
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          if [ "$STATUS" != "200" ]; then
            echo "site_down=true" >> $GITHUB_OUTPUT
          else
            echo "site_down=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ§© VÃ©rification des derniers workflows GitHub
        id: actions
        run: |
          gh run list --limit 5 --json name,conclusion,createdAt > runs.json
          FAILS=$(jq '[.[] | select(.conclusion=="failure")] | length' runs.json)
          echo "failures=$FAILS" >> $GITHUB_OUTPUT
          if [ "$FAILS" -gt 0 ]; then
            echo "workflow_failed=true" >> $GITHUB_OUTPUT
          else
            echo "workflow_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸš‘ DÃ©clenchement Auto-Heal si problÃ¨me dÃ©tectÃ©
        if: steps.check.outputs.site_down == 'true' || steps.actions.outputs.workflow_failed == 'true'
        run: |
          echo "âš ï¸ ProblÃ¨me dÃ©tectÃ© â€” lancement du processus de guÃ©rison."
          git config --global user.name "Sentinel Auto-Heal Bot"
          git config --global user.email "ai-kernel@sentinel"
          git pull origin main
          echo "$(date '+%Y-%m-%d %H:%M:%S') â€“ Auto-Heal dÃ©clenchÃ©" >> logs/autoheal.log
          echo "Rollback sur derniÃ¨re version stable..."
          git reset --hard HEAD~1 || true
          echo "ğŸ§± Reconstruction des dÃ©pendances..."
          npm install --force || true
          echo "ğŸš€ RedÃ©ploiement Cloudflare Pages..."
          npx wrangler pages deploy dist --project-name=sentinelquantumvanguardaipro || true

      - name: âœ… Notification Telegram â€“ Auto-Heal exÃ©cutÃ©
        if: always()
        run: |
          MSG="â™»ï¸ *Auto-Heal Sentinel exÃ©cutÃ©*%0A"
          MSG+="ğŸ•’ $(date '+%Y-%m-%d %H:%M:%S UTC')%0A"
          MSG+="ğŸŒ Site : ${CLOUDFLARE_URL}%0A"
          if [ "${{ steps.check.outputs.site_down }}" == "true" ]; then
            MSG+="âš ï¸ Cloudflare DOWN â†’ RÃ©paration lancÃ©e%0A"
          fi
          if [ "${{ steps.actions.outputs.workflow_failed }}" == "true" ]; then
            MSG+="âŒ Build Ã©chouÃ© â†’ Rollback + rebuild effectuÃ©%0A"
          fi
          MSG+="%0AğŸ§  RÃ©activation des agents IA de supervision.%0A"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            --data-urlencode "text=$MSG"

      - name: ğŸ§  RÃ©activation des agents IA Sentinel
        run: |
          echo "RedÃ©marrage des mÃ©ta-agents Sentinel..."
          gh workflow run sentinel-interactive-bot.yml --ref main || true
          gh workflow run sentinel-telegram-console.yml --ref main || true
          gh workflow run sentinel-critical-alerts.yml --ref main || true
