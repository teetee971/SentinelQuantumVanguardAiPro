name: 🚀 Build & Release AutoDeploy ZIP

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  package:
    name: "📦 Package AutoDeploy ZIP"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: 🗜️ Create Cloud Edition ZIP
        run: |
          mkdir -p release-pack
          cp -r .github release-pack/
          cp firebase.json .firebaserc README_AutoDeploy.txt release-pack/ || true
          cd release-pack && zip -r ../SentinelQuantumVanguardAiPro_AutoDeploy_CloudEdition.zip .

      - name: 🚀 Publish ZIP to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: autodeploy-${{ github.run_number }}
          name: "AutoDeploy Cloud Edition Build ${{ github.run_number }}"
          files: SentinelQuantumVanguardAiPro_AutoDeploy_CloudEdition.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_complete_zip:
    name: "🧱 Build Complete AutoDeploy ZIP"
    runs-on: ubuntu-latest
    needs: [package]
    steps:
      - uses: actions/checkout@v4

      - name: 🗂️ Assemble full AutoDeploy package
        run: |
          mkdir -p SentinelQuantumVanguardAiPro_AutoDeploy_Final/.github/workflows
          cp -r .github/workflows/release-autodeploy.yml SentinelQuantumVanguardAiPro_AutoDeploy_Final/.github/workflows/
          cp -r .github/workflows/sentinel-autodeploy.yml SentinelQuantumVanguardAiPro_AutoDeploy_Final/.github/workflows/ || true
          cp firebase.json .firebaserc README_AutoDeploy.txt LICENSE_PRIVATE.txt SentinelQuantumVanguardAiPro_AutoDeploy_Final/ || true
          cd SentinelQuantumVanguardAiPro_AutoDeploy_Final
          zip -r ../SentinelQuantumVanguardAiPro_AutoDeploy_Final.zip .
          cd ..
          echo "✅ ZIP complet généré : SentinelQuantumVanguardAiPro_AutoDeploy_Final.zip"

      - name: 🚀 Publish Complete ZIP to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: fullbuild-${{ github.run_number }}
          name: "Sentinel Full AutoDeploy Build ${{ github.run_number }}"
          files: SentinelQuantumVanguardAiPro_AutoDeploy_Final.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update_readme_dashboard:
    name: "📊 Update IA Dashboard"
    runs-on: ubuntu-latest
    needs: [build_complete_zip]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 🧠 Update IA dashboard timestamps
        run: |
          TODAY=$(date +"%d/%m/%Y %H:%M")
          sed -i "s|\$(date .*)|$TODAY|g" README.md
          echo "✅ Tableau IA mis à jour automatiquement → $TODAY"

      - name: 🛰️ Commit & push dashboard update
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "Sentinel AutoDeploy Bot"
          git config user.email "sentinel-bot@users.noreply.github.com"
          git add README.md
          git commit -m "🤖 Auto-update: IA Dashboard refreshed at $TODAY" || echo "No changes to commit"
          git push

  tag_release:
    name: "🏷️ Tag & Release AutoDeploy Build"
    runs-on: ubuntu-latest
    needs: [update_readme_dashboard]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: 🏷️ Create tag & push release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v$(date +'%Y.%m.%d.%H%M')"
          git config user.name "Sentinel Release Bot"
          git config user.email "release-bot@users.noreply.github.com"
          git tag -a "$TAG" -m "AutoDeploy Build $TAG"
          git push origin "$TAG"
          echo "✅ Version taguée : $TAG"