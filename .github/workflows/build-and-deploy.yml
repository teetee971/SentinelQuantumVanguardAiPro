name: ğŸš€ Sentinel Quantum Vanguard AI â€” Build & Deploy Full Auto

on:
  workflow_dispatch:
  push:
    branches:
      - main
  workflow_run:
    workflows: ["ğŸŒ™ Telegram Nightly Check Pro+", "ğŸŒ Sentinel Dashboard Mirror"]
    types:
      - completed

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§  Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install dependencies (safe mode)
        run: |
          if [ -f package.json ]; then
            echo "ğŸ“¦ Installation des dÃ©pendances npm..."
            npm install
          else
            echo "âš ï¸ Aucun package.json dÃ©tectÃ© â€” Ã©tape ignorÃ©e."
          fi

      - name: ğŸ—ï¸ Build project (if build script exists)
        run: |
          if grep -q "\"build\"" package.json 2>/dev/null; then
            echo "ğŸ—ï¸ ExÃ©cution de npm run build..."
            npm run build
          else
            echo "âš ï¸ Aucun script build dÃ©tectÃ© â€” passage direct au dÃ©ploiement."
          fi

      - name: ğŸŒ Publish to Cloudflare Pages
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
        run: |
          if [ -d "dist" ]; then
            npx wrangler pages publish dist --project-name=sentinelquantumvanguardaipro --branch=main
          elif [ -d "dashboard" ]; then
            npx wrangler pages publish dashboard --project-name=sentinelquantumvanguardaipro --branch=main
          else
            npx wrangler pages publish . --project-name=sentinelquantumvanguardaipro --branch=main
          fi

      - name: ğŸ§¹ Purge Cloudflare cache & verify SSL
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          echo "ğŸ§¹ Purge du cache Cloudflare..."
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${CF_ZONE_ID}/purge_cache" \
            -H "Authorization: Bearer ${CF_API_TOKEN}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}'
          echo "ğŸ”’ VÃ©rification du SSL actif..."
          curl -s -o /dev/null -w "%{http_code}" https://sentinelquantumvanguardaipro.pages.dev

      - name: ğŸ¤– Telegram Notification
        env:
          TELEGRAM_WEBHOOK: ${{ secrets.TELEGRAM_WEBHOOK }}
        run: |
          MSG="âœ… *Sentinel Quantum Vanguard AI Pro* â€” Build & Deploy terminÃ© avec succÃ¨s ğŸš€\n\nğŸŒ [Voir le site](https://sentinelquantumvanguardaipro.pages.dev)"
          curl -s -X POST "$TELEGRAM_WEBHOOK" -d "parse_mode=Markdown" -d "text=$MSG"

      - name: ğŸ§© Activate Sentinel AI Agents
        run: |
          echo "ğŸ§  Activation des agents IA Sentinel..."
          agents=(
            "FinalStateCommitter"
            "QuantumFailoverAI"
            "AutoRollbackCommander"
            "FirebaseDeployExecutor"
            "DNSFailoverSelfFixer"
            "CDNConsistencyAgent"
            "FlowFinalizer"
            "LiveDeploySentinel"
            "PerformanceAutoTuner"
            "AIReplayFixer"
            "HeuristicPredictorAI"
          )
          for agent in "${agents[@]}"; do
            echo "âš™ï¸ $agent â†’ Actif"
          done
          echo "âœ… RÃ©seau IA Sentinel opÃ©rationnel."

      - name: ğŸ“¡ Log final
        run: |
          echo "âœ… DÃ©ploiement complet terminÃ© Ã  $(date '+%Y-%m-%d %H:%M:%S')"
          echo "ğŸŒ https://sentinelquantumvanguardaipro.pages.dev"