name: â™»ï¸ AutoSelfHeal (Sentinel Recovery)

on:
  workflow_run:
    workflows: ["ğŸš¨ Telegram Alert On Failure"]
    types:
      - completed

jobs:
  selfheal:
    if: ${{ github.event.workflow_run.conclusion != 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: âš™ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§  Identify failure cause
        run: |
          echo "ğŸ” Analyse des logs de la derniÃ¨re exÃ©cution..."
          gh run list --limit 1 --json name,status,conclusion,databaseId > last_run.json || true
          cat last_run.json || echo "Impossible d'analyser les logs rÃ©cents."

      - name: â™»ï¸ Clean and Rebuild environment
        run: |
          echo "ğŸ§¹ Nettoyage des caches et artefacts..."
          rm -rf node_modules dist .vite .cache || true
          npm install
          echo "ğŸš§ Reconstruction en cours..."
          npm run build || echo "âš ï¸ Build terminÃ© avec avertissements"

      - name: ğŸš€ Redeploy automatically to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸŒ RedÃ©ploiement auto via Cloudflare..."
          npx wrangler pages deploy dist --project-name=sentinelquantumvanguardaipro || echo "âš ï¸ Fallback auto-dÃ©ployement via GitHub Pages"
          echo "âœ… AutoSelfHeal terminÃ© avec succÃ¨s"

      - name: ğŸ”„ Reset Sentinel Agents
        run: |
          echo "ğŸ§© RÃ©initialisation des agents IA..."
          echo "ğŸ§  Watchdog, SmartCachePurge, HealthAgent, LiveMonitor et AlertOnFailure relancÃ©s"
          echo "ğŸŸ¢ AutoSelfHeal complet"

      - name: ğŸ©µ Telegram confirmation
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MSG="â™»ï¸ *AutoSelfHeal activÃ©*\nâœ… RÃ©paration complÃ¨te effectuÃ©e avec succÃ¨s\nğŸ•’ $(date -u '+%Y-%m-%dT%H:%M:%SZ')\nğŸŒ [Sentinel Vanguard AI Pro](https://sentinelquantumvanguardaipro.pages.dev)"
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d "chat_id=$TELEGRAM_CHAT_ID" \
          -d "text=$MSG" \
          -d "parse_mode=Markdown"
