name: ğŸŒ Wave 18 â€“ Sentinel Neural Telemetry Core (Realtime Metrics Stream)

on:
  schedule:
    - cron: "*/15 * * * *"   # toutes les 15 minutes
  workflow_dispatch:

jobs:
  telemetry:
    runs-on: ubuntu-latest
    name: ğŸ“¡ Neural Telemetry Engine
    steps:
      - name: ğŸš€ Initialisation
        run: |
          echo "ğŸ“¡ Initialisation du moteur de tÃ©lÃ©mÃ©trie"
          mkdir -p public/telemetry logs
          echo "$(date '+%F %T') | DÃ©but Wave 18" >> logs/telemetry.log

      - name: ğŸ“¥ TÃ©lÃ©chargement des logs d'analyse
        uses: actions/download-artifact@v4
        with:
          path: logs/input
        continue-on-error: true

      - name: ğŸ§© GÃ©nÃ©ration du flux JSON
        run: |
          echo "Conversion des logs en flux JSON..."
          jq -Rs '{timestamp: now, raw: ., type:"fusion"}' logs/input/* 2>/dev/null \
             > public/telemetry/data.json || echo '{"timestamp":'$(date +%s)',"status":"no_data"}' > public/telemetry/data.json
          echo "$(date '+%T') | Flux JSON gÃ©nÃ©rÃ©" >> logs/telemetry.log

      - name: ğŸ§  Construction du tableau HTML
        run: |
          echo "<!DOCTYPE html><html lang='fr'><head><meta charset='utf-8'><title>Sentinel Telemetry</title>" > public/telemetry/index.html
          echo "<meta name='viewport' content='width=device-width,initial-scale=1'>" >> public/telemetry/index.html
          echo "<style>body{font-family:Inter,Roboto,Arial;background:#0b0f19;color:#e5e5e5;margin:2em;}h1{color:#00ffe0;}pre{background:#111827;padding:1em;border-radius:12px;white-space:pre-wrap;}</style></head><body>" >> public/telemetry/index.html
          echo "<h1>ğŸ“¡ Sentinel Neural Telemetry Core</h1><p>DerniÃ¨re mise Ã  jour : $(date '+%F %T')</p><hr>" >> public/telemetry/index.html
          echo "<pre id='data'></pre><script>fetch('data.json').then(r=>r.json()).then(j=>{document.getElementById('data').textContent=JSON.stringify(j,null,2);});setInterval(()=>location.reload(),1800000);</script></body></html>" >> public/telemetry/index.html

      - name: ğŸ§¾ Validation du flux
        run: |
          echo "âœ… Fichiers gÃ©nÃ©rÃ©s dans /public/telemetry"
          ls -l public/telemetry

      - name: ğŸ“² Notification Telegram (optionnelle)
        if: always()
        run: |
          if [ -n "${{ secrets.TELEGRAM_WEBHOOK }}" ]; then
            MSG="ğŸŒ Sentinel Telemetry Core mis Ã  jour : $(date '+%T')"
            curl -s -X POST ${{ secrets.TELEGRAM_WEBHOOK }} -d "text=$MSG"
          fi

      - name: ğŸ—‚ï¸ Upload des artefacts
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-neural-telemetry
          path: public/telemetry/
