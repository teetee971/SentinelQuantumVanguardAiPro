name: Build and Release Android APK

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  # Required GitHub Secrets for APK signing:
  # - RELEASE_KEYSTORE_BASE64: Base64 encoded keystore file
  # - RELEASE_KEYSTORE_PASSWORD: Password for the keystore
  # - RELEASE_KEY_ALIAS: Alias for the signing key
  # - RELEASE_KEY_PASSWORD: Password for the signing key
  APK_NAME: SentinelQuantumVanguardAIPro

jobs:
  build-and-release:
    name: Build Signed Release APK and Create GitHub Release
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          echo "üîê Validating required secrets..."
          MISSING_SECRETS=""
          
          if [ -z "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}RELEASE_KEYSTORE_BASE64 "
          fi
          
          if [ -z "${{ secrets.RELEASE_KEYSTORE_PASSWORD }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}RELEASE_KEYSTORE_PASSWORD "
          fi
          
          if [ -z "${{ secrets.RELEASE_KEY_ALIAS }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}RELEASE_KEY_ALIAS "
          fi
          
          if [ -z "${{ secrets.RELEASE_KEY_PASSWORD }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}RELEASE_KEY_PASSWORD "
          fi
          
          if [ -n "$MISSING_SECRETS" ]; then
            echo "‚ùå ERROR: Missing required secrets: ${MISSING_SECRETS}"
            echo ""
            echo "üìñ Please configure the following secrets in GitHub:"
            echo "   Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            echo ""
            echo "   Required secrets:"
            echo "   - RELEASE_KEYSTORE_BASE64: Base64 encoded keystore file"
            echo "   - RELEASE_KEYSTORE_PASSWORD: Password for the keystore"
            echo "   - RELEASE_KEY_ALIAS: Alias for the signing key"
            echo "   - RELEASE_KEY_PASSWORD: Password for the signing key"
            echo ""
            echo "üìñ See RELEASE_KEYSTORE_SETUP.md for keystore generation instructions."
            exit 1
          fi
          
          echo "‚úÖ All required secrets are configured"

      - name: Set up Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: android-app/package-lock.json

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Gradle with caching
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: wrapper
          cache-read-only: false

      - name: Install Node dependencies
        working-directory: android-app
        run: npm ci

      - name: Decode release keystore
        working-directory: android-app/android/app
        env:
          KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
        run: |
          echo "üîê Decoding release keystore from secrets..."
          # Use environment variable to avoid exposing in logs
          echo "$KEYSTORE_BASE64" | base64 --decode > release.keystore
          
          if [ ! -f release.keystore ]; then
            echo "‚ùå ERROR: Failed to decode keystore"
            exit 1
          fi
          
          # Portable size check
          KEYSTORE_SIZE=0
          if stat -c%s release.keystore > /dev/null 2>&1; then
            KEYSTORE_SIZE=$(stat -c%s release.keystore)
          elif stat -f%z release.keystore > /dev/null 2>&1; then
            KEYSTORE_SIZE=$(stat -f%z release.keystore)
          else
            KEYSTORE_SIZE=$(wc -c < release.keystore | tr -d ' ')
          fi
          
          if [ "$KEYSTORE_SIZE" -lt 1000 ]; then
            echo "‚ùå ERROR: Keystore file is too small (${KEYSTORE_SIZE} bytes)"
            echo "   Please verify RELEASE_KEYSTORE_BASE64 is correctly encoded"
            exit 1
          fi
          
          echo "‚úÖ Release keystore decoded successfully (${KEYSTORE_SIZE} bytes)"

      - name: Make gradlew executable
        working-directory: android-app/android
        run: chmod +x gradlew

      - name: Build Signed Release APK
        working-directory: android-app/android
        env:
          KEYSTORE_FILE: ${{ github.workspace }}/android-app/android/app/release.keystore
          KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: |
          echo "üî® Building signed release APK..."
          ./gradlew assembleRelease --no-daemon --stacktrace \
            -Pandroid.injected.signing.store.file="$KEYSTORE_FILE" \
            -Pandroid.injected.signing.store.password="$KEYSTORE_PASSWORD" \
            -Pandroid.injected.signing.key.alias="$KEY_ALIAS" \
            -Pandroid.injected.signing.key.password="$KEY_PASSWORD"

      - name: Cleanup sensitive files
        if: always()
        working-directory: android-app/android/app
        run: |
          if [ -f release.keystore ]; then
            # Use shred if available for secure deletion
            if command -v shred &> /dev/null; then
              shred -u release.keystore 2>/dev/null || rm -f release.keystore
            else
              rm -f release.keystore
            fi
          fi
          echo "‚úÖ Cleaned up sensitive files"

      - name: Verify APK was built and signed
        run: |
          APK_PATH="android-app/android/app/build/outputs/apk/release/app-release.apk"
          
          if [ ! -f "$APK_PATH" ]; then
            echo "‚ùå ERROR: APK not found at $APK_PATH"
            exit 1
          fi
          
          APK_SIZE=$(stat -c%s "$APK_PATH")
          MIN_SIZE=10485760  # 10 MB minimum
          
          echo "üì¶ APK found at: $APK_PATH"
          echo "üìä APK size: $APK_SIZE bytes ($(du -h "$APK_PATH" | cut -f1))"
          echo "‚öôÔ∏è  Minimum required: $MIN_SIZE bytes (10 MB)"
          
          if [ "$APK_SIZE" -lt "$MIN_SIZE" ]; then
            echo "‚ùå ERROR: APK is too small ($APK_SIZE bytes < 10 MB)"
            echo "‚ùå This indicates the build may have failed or produced an invalid APK"
            exit 1
          fi
          
          echo "‚úÖ APK size validation passed"
          
          # Verify APK signature using apksigner
          echo ""
          echo "üîê Verifying APK signature..."
          if command -v apksigner &> /dev/null; then
            apksigner verify --verbose "$APK_PATH" && echo "‚úÖ APK signature verified" || {
              echo "‚ùå ERROR: APK signature verification failed"
              exit 1
            }
          else
            echo "‚ö†Ô∏è  apksigner not found, using jarsigner for verification"
            jarsigner -verify -verbose -certs "$APK_PATH" | head -20
          fi

      - name: Determine version
        id: version
        run: |
          # Priority: workflow input > tag > TRIGGER_RELEASE.txt
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ -n "${{ github.ref_name }}" ] && [[ "${{ github.ref_name }}" == v* ]]; then
            VERSION="${{ github.ref_name }}"
          elif [ -f "TRIGGER_RELEASE.txt" ]; then
            VERSION=$(cat TRIGGER_RELEASE.txt | tr -d '[:space:]')
          else
            VERSION="1.0.0"
          fi
          VERSION="${VERSION#v}"  # Remove 'v' prefix if present
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "‚úÖ Release version: ${VERSION}"

      - name: Rename APK for release
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          cp android-app/android/app/build/outputs/apk/release/app-release.apk \
             "SentinelQuantumVanguardAIPro-v${VERSION}.apk"
          
          echo "‚úÖ APK renamed to: SentinelQuantumVanguardAIPro-v${VERSION}.apk"
          ls -lh "SentinelQuantumVanguardAIPro-v${VERSION}.apk"

      - name: Generate APK SHA-256 checksum
        id: checksum
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          APK_FILE="SentinelQuantumVanguardAIPro-v${VERSION}.apk"
          
          # Generate SHA-256 hash
          SHA256=$(sha256sum "$APK_FILE" | awk '{print $1}')
          echo "SHA256=${SHA256}" >> $GITHUB_OUTPUT
          
          # Create checksum file
          echo "${SHA256}  ${APK_FILE}" > "${APK_FILE}.sha256"
          
          echo "‚úÖ SHA-256 checksum generated"
          echo "üìã Hash: ${SHA256}"
          cat "${APK_FILE}.sha256"

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          cat > release_notes.md << 'EOF'
          # Sentinel Quantum Vanguard AI Pro - Android APK
          
          ## üì± Production Release v$VERSION
          
          ### ‚úÖ Features Included
          
          - **Real-time Call Detection** - Detects incoming calls using Android TelephonyManager
          - **Caller Identification** - Shows caller number, country, and risk level
          - **Spam Protection** - Block and flag suspicious numbers
          - **Call History** - Persistent local storage of all calls
          - **Privacy First** - All data stored locally, no cloud upload
          
          ### üì• Installation
          
          1. Download `SentinelQuantumVanguardAIPro-v$VERSION.apk`
          2. Enable "Install from unknown sources" in Android settings
          3. Install the APK
          4. Grant required permissions (Phone State, Call Log, Contacts)
          5. Open app and activate Phone Security module
          
          ### üìã Requirements
          
          - Android 6.0 (API 23) or higher (optimized for Android 12+)
          - ~30 MB storage space
          - Phone permission access
          
          ### üîê Permissions
          
          - `READ_PHONE_STATE` - Detect incoming calls
          - `READ_CALL_LOG` - Access call history
          - `READ_CONTACTS` - Enrich caller ID
          - `RECEIVE_BOOT_COMPLETED` - Persist monitoring after reboot
          
          ### üîí Security & Verification
          
          This APK is **officially signed** with a production release keystore.
          
          **Verify APK integrity:**
          ```bash
          # Linux/Mac
          sha256sum -c SentinelQuantumVanguardAIPro-v$VERSION.apk.sha256
          
          # Windows (PowerShell)
          Get-FileHash SentinelQuantumVanguardAIPro-v$VERSION.apk -Algorithm SHA256
          ```
          
          **Verify APK signature:**
          ```bash
          apksigner verify --print-certs SentinelQuantumVanguardAIPro-v$VERSION.apk
          ```
          
          ### ‚ö†Ô∏è Important Notes
          
          - This is a **REAL functional app**, not a demo
          - All features work on real Android devices
          - No root access required
          - Google Play compliant permissions
          - 100% local data storage
          
          ### üêõ Known Limitations
          
          - Call blocking saves to local blocklist only (system blocking requires Telecom API)
          - Country detection is basic (based on phone number format)
          - Spam detection uses simple heuristics (ML model coming in future release)
          
          ### üìö Documentation
          
          - [Android README](https://github.com/teetee971/SentinelQuantumVanguardAiPro/blob/main/ANDROID_README.md)
          - [Test Guide](https://github.com/teetee971/SentinelQuantumVanguardAiPro/blob/main/APK_TEST_GUIDE.md)
          - [Technical Validation](https://github.com/teetee971/SentinelQuantumVanguardAiPro/blob/main/VALIDATION_FINALE.md)
          
          ### üîó Links
          
          - **GitHub Repository**: https://github.com/teetee971/SentinelQuantumVanguardAiPro
          - **Website**: https://sentinelquantumvanguardaipro.pages.dev
          
          ---
          
          **Built with:** React Native 0.73.2, Android SDK 34, JDK 17  
          **Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')  
          **Build Type:** Release (Signed)
          EOF
          
          # Replace $VERSION placeholder
          sed -i "s/\$VERSION/$VERSION/g" release_notes.md
          
          echo "‚úÖ Release notes generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Release v${{ steps.version.outputs.VERSION }}
          body_path: release_notes.md
          files: |
            SentinelQuantumVanguardAIPro-v*.apk
            SentinelQuantumVanguardAIPro-v*.apk.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Display release info
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          
          echo "================================================"
          echo "‚úÖ Release Published Successfully!"
          echo "================================================"
          echo "üì¶ APK: SentinelQuantumVanguardAIPro-v${VERSION}.apk"
          echo "üè∑Ô∏è  Tag: v${VERSION}"
          echo "üîó Release URL: https://github.com/teetee971/SentinelQuantumVanguardAiPro/releases/tag/v${VERSION}"
          echo "üì• Direct Download: https://github.com/teetee971/SentinelQuantumVanguardAiPro/releases/download/v${VERSION}/SentinelQuantumVanguardAIPro-v${VERSION}.apk"
          echo "================================================"
