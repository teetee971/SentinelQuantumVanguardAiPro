name: ğŸ§© Sentinel Auto-Healer

on:
  workflow_run:
    workflows: ["ğŸš€ Publish Sentinel Dashboard to Cloudflare Pages", "ğŸŒŒ Sentinel Nightly Health Monitor"]
    types:
      - completed
  workflow_dispatch:

jobs:
  auto_healer:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ§  VÃ©rification de lâ€™Ã©tat Cloudflare Pages
        run: |
          echo "ğŸ©º VÃ©rification automatique du statut Sentinel..."
          STATUS_CODE=$(curl -o /dev/null -s -w "%{http_code}" https://sentinelquantumvanguardaipro.pages.dev)
          echo "Code de retour : $STATUS_CODE" > logs/autoheal.log
          if [ "$STATUS_CODE" -ne 200 ]; then
            echo "âŒ Ã‰chec dÃ©tectÃ© : redÃ©ploiement nÃ©cessaire."
            echo "trigger=1" > logs/heal_trigger.txt
          else
            echo "âœ… Site fonctionnel, aucune action requise."
            echo "trigger=0" > logs/heal_trigger.txt
          fi

      - name: ğŸš‘ Relance automatique du dÃ©ploiement si Ã©chec
        if: contains(runner.debug, 'trigger=1')
        run: |
          echo "âš™ï¸ Relance automatique du dÃ©ploiement Cloudflare Pages..."
          gh workflow run "ğŸš€ Publish Sentinel Dashboard to Cloudflare Pages"
          echo "ğŸ©¹ DÃ©ploiement relancÃ© automatiquement."

      - name: ğŸ“¡ Notification Telegram (Auto-Heal)
        run: |
          RESULT=$(cat logs/autoheal.log)
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="ğŸ§© Sentinel Auto-Healer\nğŸ” ${RESULT}\nğŸ•’ $(date)"

      - name: âœ… Fin du cycle Auto-Heal
        run: echo "âœ”ï¸ Sentinel Auto-Healer terminÃ© avec succÃ¨s."