name: ğŸ” Wave 31 â€“ Sentinel Evolution Engine (Auto-Upgrade Core)

on:
  schedule:
    - cron: "0 */6 * * *"     # toutes les 6 h
  workflow_dispatch:

jobs:
  evolution:
    runs-on: ubuntu-latest
    name: ğŸ” Sentinel Evolution Engine
    steps:
      - name: ğŸš€ Initialisation
        run: |
          echo "ğŸ” Lancement du moteur Evolution"
          mkdir -p logs evolution
          echo "$(date '+%F %T') | DÃ©but Wave 31" >> logs/evolution.log

      - name: ğŸ“¡ Lecture des Ã©tats collectifs
        run: |
          cp public/telemetry/collective_intelligence.json evolution/collective.json 2>/dev/null || echo '{}' > evolution/collective.json
          cp public/telemetry/adaptive_model.json evolution/adaptive.json 2>/dev/null || echo '{}' > evolution/adaptive.json

      - name: ğŸ§® DÃ©tection des modules obsolÃ¨tes
        run: |
          echo "VÃ©rification des dÃ©pendances..."
          jq -n --slurpfile c evolution/collective.json --slurpfile a evolution/adaptive.json '
          {
            timestamp: now,
            avg_score: ([.a[0].nodes[]?.score] | add / (length + 0.1)),
            upgrade_required: (if [.c[0].sentinel_collective_index] | add < 70 then true else false end),
            suggestions: [
              "Mettre Ã  jour React / Tailwind",
              "Revalider workflows GitHub Actions",
              "Synchroniser secrets Cloudflare / Render"
            ]
          }' > public/telemetry/evolution_report.json
          echo "âœ… Rapport Evolution gÃ©nÃ©rÃ©" >> logs/evolution.log

      - name: ğŸ§¾ GÃ©nÃ©ration changelog Markdown
        run: |
          jq -r '
            "# Sentinel Evolution Engine\n\n" +
            "Horodatage : " + (.timestamp|tostring) + "\n" +
            "Score moyen rÃ©seau : " + (.avg_score|tostring) + "\n" +
            "Upgrade nÃ©cessaire : " + (.upgrade_required|tostring) + "\n\n" +
            "## Suggestions\n" +
            (.suggestions|map("- " + .)|join("\n")) + "\n"
          ' public/telemetry/evolution_report.json > public/telemetry/evolution_changelog.md
          echo "âœ… Changelog gÃ©nÃ©rÃ©" >> logs/evolution.log

      - name: ğŸ’¾ Commit
        run: |
          git config --global user.name "Sentinel-Evolution"
          git config --global user.email "evolution@sentinel"
          git add public/telemetry/evolution_*
          git commit -m "ğŸ” Update Evolution Engine report $(date +%T)" || echo "Aucune modification"
          git push || echo "Push non nÃ©cessaire"

      - name: ğŸ“² Notification Telegram
        if: always()
        run: |
          if [ -n "${{ secrets.TELEGRAM_WEBHOOK }}" ]; then
            MSG="ğŸ” [Sentinel Evolution Engine] Rapport mis Ã  jour â€“ upgrade : $(jq -r '.upgrade_required' public/telemetry/evolution_report.json)"
            curl -s -X POST ${{ secrets.TELEGRAM_WEBHOOK }} -d "text=$MSG"
          fi

      - name: ğŸ—‚ï¸ Upload logs
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-evolution-engine-logs
          path: logs/
