name: SUPERPACK_EXTRACT_AND_DEPLOY

on:
  release:
    types: [published]

env:
  EXTRACT_DIR: extracted_superpack
  BUILD_DIR: build_artifacts

jobs:

  download:
    name: Download SUPERPACK Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Download latest release assets
        id: download
        uses: robinraju/release-downloader@v1.10
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: "*.zip"
          outDir: ${{ env.EXTRACT_DIR }}

      - name: List downloaded files
        run: ls -R $EXTRACT_DIR


  extract:
    name: Extract SUPERPACK Content
    runs-on: ubuntu-latest
    needs: download
    steps:
      - name: Extract ZIP
        run: |
          mkdir -p $EXTRACT_DIR
          unzip $EXTRACT_DIR/*.zip -d $EXTRACT_DIR

      - name: List extracted files
        run: ls -R $EXTRACT_DIR


  validate:
    name: Sentinel Integrity Check
    runs-on: ubuntu-latest
    needs: extract
    steps:
      - name: Validate structure
        run: |
          echo "Running Sentinel structure validation..."
          if [ ! -d "$EXTRACT_DIR" ]; then
            echo "ERROR: Extract directory missing."
            exit 1
          fi
          echo "Integrity OK."


  prepare_deploy:
    name: Prepare Deployment Artifacts
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Create deployment directory
        run: mkdir -p $BUILD_DIR

      - name: Copy extracted content
        run: cp -R $EXTRACT_DIR/* $BUILD_DIR/

      - name: List deployment directory
        run: ls -R $BUILD_DIR


  deploy_cloudflare:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: prepare_deploy
    # Phase A: Cloudflare deployment is optional (GitHub Pages is primary deployment target)
    # This job only runs when Cloudflare secrets are configured
    if: ${{ secrets.CF_API_TOKEN != '' && secrets.CF_ACCOUNT_ID != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Publish to Cloudflare Pages
        if: ${{ secrets.CF_API_TOKEN != '' }}
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          accountId: ${{ secrets.CF_ACCOUNT_ID }}
          projectName: ${{ secrets.CF_PROJECT_NAME }}
          directory: ${{ env.BUILD_DIR }}

      - name: Confirm Deployment
        if: ${{ secrets.CF_API_TOKEN != '' }}
        run: echo "Cloudflare Pages deployment completed."
      
      - name: Cloudflare Deployment Skipped
        if: ${{ secrets.CF_API_TOKEN == '' }}
        run: echo "Cloudflare deployment skipped - secrets not configured (Phase A uses GitHub Pages)"


  deploy_firebase:
    name: Deploy to Firebase Hosting
    runs-on: ubuntu-latest
    needs: prepare_deploy
    env:
      FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
    steps:
      - uses: actions/checkout@v3

      - name: Set up Firebase tools
        if: env.FIREBASE_SERVICE_ACCOUNT != ''
        run: npm install -g firebase-tools

      - name: Firebase deploy
        if: env.FIREBASE_SERVICE_ACCOUNT != ''
        run: firebase deploy --project=${{ env.FIREBASE_PROJECT_ID }} --only hosting
        env:
          FIREBASE_TOKEN: ${{ env.FIREBASE_SERVICE_ACCOUNT }}

      - name: Confirm Firebase Deployment
        if: env.FIREBASE_SERVICE_ACCOUNT != ''
        run: echo "Firebase Hosting deployment completed."


  finalize:
    name: Sentinel Finalization
    runs-on: ubuntu-latest
    # Phase A: Allow finalization even if Cloudflare/Firebase are skipped (optional deployments)
    needs: [prepare_deploy]
    if: always()
    steps:
      - run: echo "SUPERPACK deploy pipeline finished successfully."
      - run: echo "Phase A deployment complete - GitHub Pages is the primary deployment target."
