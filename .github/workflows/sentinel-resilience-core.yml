name: ğŸ§  Sentinel Resilience Core

on:
  schedule:
    - cron: '*/30 * * * *' # toutes les 30 minutes
  workflow_dispatch:

jobs:
  resilience_core:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v4

      - name: ğŸ§© Analyse des temps de build rÃ©cents
        uses: actions/github-script@v7
        id: analyze
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const { data: runs } = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 15
            });
            const data = runs.workflow_runs.map(r => ({
              name: r.name,
              duration: ((new Date(r.updated_at) - new Date(r.run_started_at)) / 60000).toFixed(2),
              status: r.conclusion,
              started: r.run_started_at
            }));

            const avg = data.reduce((a,b) => a + parseFloat(b.duration), 0) / data.length;
            const failures = data.filter(r => r.status === "failure").length;
            const load = (failures / data.length * 100).toFixed(1);

            fs.mkdirSync('resilience', { recursive: true });
            const report = { average_duration_min: avg, failure_rate_percent: load, samples: data.length, timestamp: new Date().toISOString() };
            fs.writeFileSync('resilience/analysis.json', JSON.stringify(report, null, 2));
            core.setOutput("load", load);
            core.notice(`ğŸ“Š DurÃ©e moyenne: ${avg} min | Taux d'Ã©chec: ${load}%`);

      - name: âš™ï¸ Ajustement automatique des workflows
        if: ${{ fromJSON(steps.analyze.outputs.load) > 30 }}
        run: |
          echo "âš ï¸ Charge Ã©levÃ©e dÃ©tectÃ©e : taux dâ€™Ã©chec > 30%."
          echo "â¸ï¸ Suspension temporaire de certains workflows intensifs..."
          echo "reschedule=1" > resilience/state.txt

      - name: ğŸ§  Aucune surcharge dÃ©tectÃ©e
        if: ${{ fromJSON(steps.analyze.outputs.load) <= 30 }}
        run: |
          echo "âœ… SystÃ¨me stable : aucune action nÃ©cessaire."
          echo "reschedule=0" > resilience/state.txt

      - name: ğŸŒ GÃ©nÃ©ration du rapport HTML
        run: |
          mkdir -p public/resilience
          echo "<html><head><title>Sentinel Resilience Core</title><meta http-equiv='refresh' content='1800'></head><body style='background:#0d1117;color:#e6edf3;font-family:monospace;padding:20px;'>" > public/resilience/index.html
          echo "<h2>ğŸ§  Sentinel Resilience Core</h2><hr>" >> public/resilience/index.html
          echo "<h3>ğŸ“Š Analyse</h3><pre>" >> public/resilience/index.html
          cat resilience/analysis.json >> public/resilience/index.html
          echo "</pre><h3>âš™ï¸ Statut</h3><pre>" >> public/resilience/index.html
          cat resilience/state.txt >> public/resilience/index.html
          echo "</pre><hr><p>ğŸ•’ DerniÃ¨re vÃ©rification : $(date)</p></body></html>" >> public/resilience/index.html
          echo "âœ… Rapport HTML gÃ©nÃ©rÃ©."

      - name: ğŸš€ Publication sur Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: sentinelquantumvanguardaipro
          directory: public
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¡ Notification Telegram
        run: |
          LOAD=$(jq -r '.failure_rate_percent' resilience/analysis.json)
          AVG=$(jq -r '.average_duration_min' resilience/analysis.json)
          MSG="ğŸ§  Sentinel Resilience Core\nDurÃ©e moyenne: ${AVG} min\nTaux d'Ã©chec: ${LOAD}%\nğŸ•’ $(date)"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MSG"

      - name: âœ… Fin du cycle Resilience Core
        run: echo "âœ”ï¸ Sentinel Resilience Core terminÃ© avec succÃ¨s."