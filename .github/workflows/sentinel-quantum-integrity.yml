name: ğŸ§© Sentinel Quantum Integrity Validator

on:
  schedule:
    - cron: '30 */4 * * *' # toutes les 4h30
  workflow_dispatch:

jobs:
  integrity_check:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js et PNPM
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ§  VÃ©rification des versions
        run: |
          echo "ğŸ“¦ Versions d'environnement :" > integrity/versions.txt
          node -v >> integrity/versions.txt
          npm -v >> integrity/versions.txt
          pnpm -v >> integrity/versions.txt
          echo "âœ… VÃ©rification des versions Node / PNPM / NPM terminÃ©e."

      - name: ğŸ” VÃ©rification dâ€™intÃ©gritÃ© SHA256
        run: |
          mkdir -p integrity
          echo "ğŸ” VÃ©rification des empreintes SHA256..." > integrity/hashes.txt
          for f in package.json pnpm-lock.yaml *.yml *.yaml; do
            [ -f "$f" ] && sha256sum "$f" >> integrity/hashes.txt
          done
          echo "âœ… Empreintes SHA256 gÃ©nÃ©rÃ©es." >> integrity/hashes.txt

      - name: ğŸ§© VÃ©rification de cohÃ©rence PNPM Lockfile
        run: |
          pnpm install --frozen-lockfile || echo "âš ï¸ Lockfile non cohÃ©rent dÃ©tectÃ©." >> integrity/report.txt
          echo "âœ… VÃ©rification de cohÃ©rence du lockfile terminÃ©e." >> integrity/report.txt

      - name: ğŸ§  GÃ©nÃ©ration du rapport HTML
        run: |
          mkdir -p public/integrity
          echo "<html><head><title>Sentinel Quantum Integrity Validator</title><meta http-equiv='refresh' content='10800'></head><body style='background:#0d1117;color:#e6edf3;font-family:monospace;padding:20px;'>" > public/integrity/index.html
          echo "<h2>ğŸ§© Sentinel Quantum Integrity Validator</h2><hr>" >> public/integrity/index.html
          echo "<h3>ğŸ”¢ Versions</h3><pre>" >> public/integrity/index.html
          cat integrity/versions.txt >> public/integrity/index.html
          echo "</pre><h3>ğŸ” Empreintes SHA256</h3><pre>" >> public/integrity/index.html
          cat integrity/hashes.txt >> public/integrity/index.html
          echo "</pre><h3>ğŸ“¦ Rapport Lockfile</h3><pre>" >> public/integrity/index.html
          cat integrity/report.txt >> public/integrity/index.html
          echo "</pre><hr><p>ğŸ•’ DerniÃ¨re vÃ©rification : $(date)</p></body></html>" >> public/integrity/index.html
          echo "âœ… Rapport dâ€™intÃ©gritÃ© gÃ©nÃ©rÃ©."

      - name: ğŸš€ Publication sur Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: sentinelquantumvanguardaipro
          directory: public
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¡ Envoi rÃ©sumÃ© Telegram
        run: |
          COUNT=$(grep -c 'SHA256' integrity/hashes.txt)
          MSG="ğŸ§© Sentinel Quantum Integrity Validator\nFichiers vÃ©rifiÃ©s: ${COUNT}\nVersions Node/NPM/PNPM cohÃ©rentes.\nğŸ•’ $(date)"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MSG"

      - name: âœ… Fin du cycle Integrity Validator
        run: echo "âœ”ï¸ Sentinel Quantum Integrity Validator terminÃ© avec succÃ¨s."