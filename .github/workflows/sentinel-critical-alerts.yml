name: 🚨 Sentinel Critical Alerts – IA Surveillance Continue

on:
  workflow_run:
    workflows: ["🤖 Sentinel Interactive Bot – Commandes Telegram", "🌐 Déploiement Cloudflare", "📈 Rapport Hebdomadaire Sentinel Quantum Vanguard AI Pro"]
    types:
      - completed
  schedule:
    - cron: "*/15 * * * *" # Vérifie toutes les 15 minutes
  workflow_dispatch:

env:
  BOT_TOKEN: "7630324617:AAGYNTiOIhHFDyT83Qt_DezDUxEzEJf-K9E"
  CHAT_ID: "5707814118"
  CLOUDFLARE_URL: "https://sentinelquantumvanguardaipro.pages.dev"

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: 🔄 Checkout du dépôt
        uses: actions/checkout@v4

      - name: 📡 Vérification Cloudflare Pages
        id: check_site
        run: |
          STATUS_CODE=$(curl -Is ${CLOUDFLARE_URL} | head -1 | awk '{print $2}')
          if [ "$STATUS_CODE" != "200" ]; then
            echo "offline=true" >> $GITHUB_OUTPUT
            echo "⚠️ Cloudflare DOWN – Code $STATUS_CODE"
          else
            echo "offline=false" >> $GITHUB_OUTPUT
            echo "✅ Cloudflare OK"
          fi

      - name: 🧠 Vérification GitHub Actions
        id: check_actions
        run: |
          gh run list --limit 3 --json name,conclusion,createdAt > last_runs.json
          if jq -e '.[] | select(.conclusion=="failure")' last_runs.json > /dev/null; then
            echo "failure_detected=true" >> $GITHUB_OUTPUT
          else
            echo "failure_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: 🚨 Détection et envoi d’alerte
        if: steps.check_site.outputs.offline == 'true' || steps.check_actions.outputs.failure_detected == 'true'
        run: |
          BASE_URL="https://api.telegram.org/bot${BOT_TOKEN}"
          ALERT="🚨 *ALERTE CRITIQUE SENTINEL*%0A"
          ALERT+="🕒 $(date '+%Y-%m-%d %H:%M:%S UTC')%0A%0A"

          if [ "${{ steps.check_site.outputs.offline }}" == "true" ]; then
            ALERT+="⚠️ *Cloudflare Pages Inaccessible !*%0A"
            ALERT+="🔗 ${CLOUDFLARE_URL}%0A"
          fi

          if [ "${{ steps.check_actions.outputs.failure_detected }}" == "true" ]; then
            ALERT+="❌ *Échec d’un workflow GitHub !*%0A"
            ALERT+="🧩 Vérifie les logs sur : https://github.com/teetee971/SentinelQuantumVanguardAiPro/actions%0A"
          fi

          ALERT+="%0A🧠 IA Surveillance Continue – Module Auto-Heal en attente."

          curl -s -X POST "${BASE_URL}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            -d text="$ALERT"

      - name: ✅ Aucun problème détecté
        if: steps.check_site.outputs.offline == 'false' && steps.check_actions.outputs.failure_detected == 'false'
        run: |
          echo "Tout est stable ✅"
