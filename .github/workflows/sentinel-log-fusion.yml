name: ğŸ§  Wave 14 â€“ Sentinel AI Log Fusion (Global Observability Core)

on:
  schedule:
    - cron: "0 * * * *"    # exÃ©cution toutes les heures
  workflow_dispatch:

jobs:
  fusion:
    runs-on: ubuntu-latest
    name: ğŸ“¡ Sentinel Log Fusion Engine
    steps:
      - name: ğŸš€ Initialisation
        run: |
          echo "ğŸ§  Initialisation du moteur de fusion de logs..."
          mkdir -p logs
          echo "$(date '+%F %T') | DÃ©but Wave 14 â€“ Log Fusion" >> logs/fusion-summary.log

      - name: ğŸ“¥ RÃ©cupÃ©ration des logs prÃ©cÃ©dents
        uses: actions/download-artifact@v4
        with:
          name: backend-monitor-logs
          path: logs/prev/backend
      - uses: actions/download-artifact@v4
        with:
          name: redundancy-matrix-logs
          path: logs/prev/redundancy
      - uses: actions/download-artifact@v4
        with:
          name: sentinel-firewall-logs
          path: logs/prev/firewall

      - name: ğŸ” Fusion et analyse des journaux
        run: |
          echo "Fusion des logs Backend, Redundancy et Firewall..."
          cat logs/prev/*/* > logs/fusion-raw.log 2>/dev/null || true
          echo "---- RÃ©sumÃ© des erreurs critiques ----" >> logs/fusion-summary.log
          grep -i "error" logs/fusion-raw.log | tail -n 20 >> logs/fusion-summary.log || echo "Aucune erreur dÃ©tectÃ©e" >> logs/fusion-summary.log
          echo "---- Statistiques latence / redÃ©ploiement ----" >> logs/fusion-summary.log
          grep -i "latency" logs/fusion-raw.log | tail -n 10 >> logs/fusion-summary.log || echo "Aucune donnÃ©e de latence" >> logs/fusion-summary.log
          echo "$(date '+%T') | Fusion terminÃ©e" >> logs/fusion-summary.log

      - name: ğŸ“Š GÃ©nÃ©ration du rapport
        run: |
          echo "=== Rapport de supervision Sentinel ===" > logs/report.txt
          echo "Date : $(date)" >> logs/report.txt
          echo "" >> logs/report.txt
          tail -n 50 logs/fusion-summary.log >> logs/report.txt

      - name: ğŸ“² Notification Telegram (optionnelle)
        if: always()
        run: |
          if [ -n "${{ secrets.TELEGRAM_WEBHOOK }}" ]; then
            MSG="ğŸ“Š Sentinel Log Fusion exÃ©cutÃ© â€“ $(date '+%T')"
            curl -s -X POST ${{ secrets.TELEGRAM_WEBHOOK }} -d "text=$MSG"
          fi

      - name: ğŸ—‚ï¸ Upload du rapport fusionnÃ©
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-log-fusion
          path: logs/
