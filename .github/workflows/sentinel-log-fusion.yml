name: 🧠 Wave 14 – Sentinel AI Log Fusion (Global Observability Core)

on:
  schedule:
    - cron: "0 * * * *"    # exécution toutes les heures
  workflow_dispatch:

jobs:
  fusion:
    runs-on: ubuntu-latest
    name: 📡 Sentinel Log Fusion Engine
    steps:
      - name: 🚀 Initialisation
        run: |
          echo "🧠 Initialisation du moteur de fusion de logs..."
          mkdir -p logs
          echo "$(date '+%F %T') | Début Wave 14 – Log Fusion" >> logs/fusion-summary.log

      - name: 📥 Récupération des logs précédents
        uses: actions/download-artifact@v4
        with:
          name: backend-monitor-logs
          path: logs/prev/backend
      - uses: actions/download-artifact@v4
        with:
          name: redundancy-matrix-logs
          path: logs/prev/redundancy
      - uses: actions/download-artifact@v4
        with:
          name: sentinel-firewall-logs
          path: logs/prev/firewall

      - name: 🔍 Fusion et analyse des journaux
        run: |
          echo "Fusion des logs Backend, Redundancy et Firewall..."
          cat logs/prev/*/* > logs/fusion-raw.log 2>/dev/null || true
          echo "---- Résumé des erreurs critiques ----" >> logs/fusion-summary.log
          grep -i "error" logs/fusion-raw.log | tail -n 20 >> logs/fusion-summary.log || echo "Aucune erreur détectée" >> logs/fusion-summary.log
          echo "---- Statistiques latence / redéploiement ----" >> logs/fusion-summary.log
          grep -i "latency" logs/fusion-raw.log | tail -n 10 >> logs/fusion-summary.log || echo "Aucune donnée de latence" >> logs/fusion-summary.log
          echo "$(date '+%T') | Fusion terminée" >> logs/fusion-summary.log

      - name: 📊 Génération du rapport
        run: |
          echo "=== Rapport de supervision Sentinel ===" > logs/report.txt
          echo "Date : $(date)" >> logs/report.txt
          echo "" >> logs/report.txt
          tail -n 50 logs/fusion-summary.log >> logs/report.txt

      - name: 📲 Notification Telegram (optionnelle)
        if: always()
        run: |
          if [ -n "${{ secrets.TELEGRAM_WEBHOOK }}" ]; then
            MSG="📊 Sentinel Log Fusion exécuté – $(date '+%T')"
            curl -s -X POST ${{ secrets.TELEGRAM_WEBHOOK }} -d "text=$MSG"
          fi

      - name: 🗂️ Upload du rapport fusionné
        uses: actions/upload-artifact@v4
        with:
          name: sentinel-log-fusion
          path: logs/
