<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SOC Live Fonctionnel ‚Äî Sentinel Quantum Vanguard AI Pro</title>
  
  <link rel="stylesheet" href="shared-styles.css">
  
  <style>
    :root {
      --bg-dark: #0a0a0a;
      --bg-card: #1a1a1a;
      --bg-elevated: #222;
      --border: #333;
      --text-primary: #fff;
      --text-secondary: #aaa;
      --text-muted: #666;
      --green: #10b981;
      --red: #ef4444;
      --yellow: #f59e0b;
      --blue: #3b82f6;
      --orange: #f97316;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 999px;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--green);
    }

    .live-indicator.error {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
      color: var(--red);
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: var(--green);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.9); }
    }

    .health-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .health-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
    }

    .health-card-title {
      font-weight: 600;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-dot.online { background: var(--green); }
    .status-dot.offline { background: var(--red); }
    .status-dot.loading { background: var(--yellow); }

    .health-metric {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }

    .health-metric:last-child {
      border-bottom: none;
    }

    .metric-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .metric-value {
      font-weight: 600;
      font-family: monospace;
    }

    .events-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 2rem;
      margin-bottom: 2rem;
    }

    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }

    .event-item {
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .event-source {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-family: monospace;
    }

    .event-time {
      font-size: 0.85rem;
      color: var(--text-muted);
      font-family: monospace;
    }

    .event-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    .event-description {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .severity-badge {
      display: inline-block;
      padding: 0.25rem 0.6rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .severity-critical {
      background: rgba(239, 68, 68, 0.2);
      color: var(--red);
      border: 1px solid var(--red);
    }

    .severity-high {
      background: rgba(245, 158, 11, 0.2);
      color: var(--yellow);
      border: 1px solid var(--yellow);
    }

    .severity-medium {
      background: rgba(59, 130, 246, 0.2);
      color: var(--blue);
      border: 1px solid var(--blue);
    }

    .severity-low {
      background: rgba(16, 185, 129, 0.2);
      color: var(--green);
      border: 1px solid var(--green);
    }

    .loading-message {
      text-align: center;
      padding: 2rem;
      color: var(--text-secondary);
    }

    .error-message {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--red);
      border-radius: 6px;
      padding: 1rem;
      color: var(--red);
      margin-bottom: 1rem;
    }

    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid var(--blue);
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 2rem;
    }

    .info-box p {
      color: var(--text-secondary);
      margin: 0.5rem 0;
    }

    .refresh-button {
      background: var(--green);
      color: #000;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .refresh-button:hover {
      opacity: 0.8;
    }

    .refresh-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <script src="shared-navigation.js"></script>

  <div class="container">
    <div class="page-header">
      <h1 class="page-title">
        SOC Live Fonctionnel
        <span class="live-indicator" id="systemStatus">
          <span class="live-dot"></span>
          <span id="statusText">CHARGEMENT...</span>
        </span>
      </h1>
      <p style="color: var(--text-secondary); margin-bottom: 1rem;">
        Centre d'op√©rations de s√©curit√© avec donn√©es r√©elles ‚Äî Sources publiques v√©rifiables
      </p>
      <button class="refresh-button" onclick="refreshAllData()" id="refreshBtn">
        üîÑ Actualiser les donn√©es
      </button>
    </div>

    <div class="info-box">
      <p><strong>‚úÖ SOC Fonctionnel avec donn√©es r√©elles ‚Äî PHASE B (NO-FAKE)</strong></p>
      <p>‚Ä¢ <strong>Sources publiques v√©rifiables:</strong> GitHub Security Advisories, CVE/NVD, CISA Advisories</p>
      <p>‚Ä¢ <strong>√âv√©nements r√©els:</strong> Horodat√©s, tra√ßables, issus de bases officielles</p>
      <p>‚Ä¢ <strong>Sant√© syst√®me:</strong> Indicateurs de disponibilit√© et latence r√©els</p>
      <p>‚Ä¢ <strong>Transparence totale:</strong> Aucune donn√©e fictive, simul√©e ou offensive</p>
      <p>‚Ä¢ <strong>Rafra√Æchissement automatique:</strong> Mise √† jour toutes les 5 minutes</p>
    </div>

    <div class="health-grid">
      <div class="health-card">
        <div class="health-card-title">
          <span>üîå GitHub Security API</span>
          <span class="status-dot loading" id="githubStatus"></span>
        </div>
        <div class="health-metric">
          <span class="metric-label">Statut</span>
          <span class="metric-value" id="githubStatusText">V√©rification...</span>
        </div>
        <div class="health-metric">
          <span class="metric-label">√âv√©nements charg√©s</span>
          <span class="metric-value" id="githubCount">0</span>
        </div>
        <div class="health-metric">
          <span class="metric-label">Derni√®re mise √† jour</span>
          <span class="metric-value" id="githubLastUpdate">-</span>
        </div>
      </div>

      <div class="health-card">
        <div class="health-card-title">
          <span>üõ°Ô∏è CVE/NVD API</span>
          <span class="status-dot loading" id="cveStatus"></span>
        </div>
        <div class="health-metric">
          <span class="metric-label">Statut</span>
          <span class="metric-value" id="cveStatusText">V√©rification...</span>
        </div>
        <div class="health-metric">
          <span class="metric-label">CVEs charg√©es</span>
          <span class="metric-value" id="cveCount">0</span>
        </div>
        <div class="health-metric">
          <span class="metric-label">Derni√®re mise √† jour</span>
          <span class="metric-value" id="cveLastUpdate">-</span>
        </div>
      </div>

      <div class="health-card">
        <div class="health-card-title">
          <span>üìä Volume Total</span>
          <span class="status-dot loading" id="totalStatus"></span>
        </div>
        <div class="health-metric">
          <span class="metric-label">Total √©v√©nements</span>
          <span class="metric-value" id="totalEvents">0</span>
        </div>
        <div class="health-metric">
          <span class="metric-label">Critiques</span>
          <span class="metric-value" style="color: var(--red)" id="criticalCount">0</span>
        </div>
        <div class="health-metric">
          <span class="metric-label">Moyens/√âlev√©s</span>
          <span class="metric-value" style="color: var(--yellow)" id="highMediumCount">0</span>
        </div>
      </div>

      <div class="health-card">
        <div class="health-card-title">
          <span>üåç Niveau de Menace Global</span>
          <span class="status-dot online" id="threatLevelStatus"></span>
        </div>
        <div class="health-metric">
          <span class="metric-label">Niveau actuel</span>
          <span class="metric-value" style="font-size: 1.2em; font-weight: bold;" id="threatLevel">MOD√âR√â</span>
        </div>
        <div class="health-metric">
          <span class="metric-label">Bas√© sur</span>
          <span class="metric-value" id="threatLevelBasis">Analyse en cours...</span>
        </div>
        <div class="health-metric">
          <span class="metric-label">Derni√®re √©valuation</span>
          <span class="metric-value" id="threatLevelTime">-</span>
        </div>
      </div>
    </div>

    <div class="events-section">
      <h2 class="section-title">üîç √âv√©nements de S√©curit√© R√©cents</h2>
      <div id="eventsContainer">
        <div class="loading-message">‚è≥ Chargement des √©v√©nements r√©els...</div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const CONFIG = {
      GITHUB_API_URL: 'https://api.github.com/advisories',
      NVD_API_URL: 'https://services.nvd.nist.gov/rest/json/cves/2.0',
      GITHUB_PER_PAGE: 15,
      NVD_PER_PAGE: 10,
      REFRESH_INTERVAL_MS: 5 * 60 * 1000, // 5 minutes
      DESCRIPTION_MAX_LENGTH: 200,
      // Threat level thresholds
      THREAT_LEVEL: {
        CRITICAL_COUNT_HIGH: 3,
        CRITICAL_RATIO_HIGH: 20, // percentage
        HIGH_MEDIUM_COUNT_MODERATE: 5,
        HIGH_MEDIUM_RATIO_MODERATE: 30 // percentage
      }
    };

    // √âtat global
    const state = {
      githubAdvisories: [],
      cveData: [],
      lastUpdate: {
        github: null,
        cve: null
      },
      health: {
        github: 'loading',
        cve: 'loading'
      }
    };

    // Utilitaires
    function truncateDescription(text, maxLength = CONFIG.DESCRIPTION_MAX_LENGTH) {
      if (!text || text.length <= maxLength) return text || '';
      return text.substring(0, maxLength) + '...';
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diff = now - date;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      
      if (days > 0) return `Il y a ${days} jour${days > 1 ? 's' : ''}`;
      if (hours > 0) return `Il y a ${hours} heure${hours > 1 ? 's' : ''}`;
      return "Il y a moins d'une heure";
    }

    // Fonction pour obtenir le niveau de s√©v√©rit√©
    function getSeverityClass(severity) {
      if (!severity) return 'severity-low';
      const s = severity.toLowerCase();
      if (s === 'critical') return 'severity-critical';
      if (s === 'high') return 'severity-high';
      if (s === 'medium' || s === 'moderate') return 'severity-medium';
      return 'severity-low';
    }

    function getSeverityText(severity) {
      if (!severity) return 'Info';
      const s = severity.toLowerCase();
      if (s === 'critical') return 'Critique';
      if (s === 'high') return '√âlev√©';
      if (s === 'medium' || s === 'moderate') return 'Moyen';
      return 'Faible';
    }

    // Charger GitHub Security Advisories
    async function loadGitHubAdvisories() {
      try {
        const url = `${CONFIG.GITHUB_API_URL}?per_page=${CONFIG.GITHUB_PER_PAGE}&sort=published&order=desc`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        state.githubAdvisories = data;
        state.lastUpdate.github = new Date();
        state.health.github = 'online';
        
        updateHealthUI('github', 'online', data.length);
        return data;
      } catch (error) {
        console.error('Erreur GitHub API:', error);
        state.health.github = 'offline';
        updateHealthUI('github', 'offline', 0);
        return [];
      }
    }

    // Charger CVE depuis NVD API
    async function loadCVEData() {
      try {
        // NVD API v2 - derni√®res CVEs modifi√©es
        const url = `${CONFIG.NVD_API_URL}?resultsPerPage=${CONFIG.NVD_PER_PAGE}`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        const cves = data.vulnerabilities || [];
        state.cveData = cves;
        state.lastUpdate.cve = new Date();
        state.health.cve = 'online';
        
        updateHealthUI('cve', 'online', cves.length);
        return cves;
      } catch (error) {
        console.error('Erreur CVE API:', error);
        state.health.cve = 'offline';
        updateHealthUI('cve', 'offline', 0);
        return [];
      }
    }

    // Mettre √† jour l'interface de sant√©
    function updateHealthUI(source, status, count) {
      const statusDot = document.getElementById(`${source}Status`);
      const statusText = document.getElementById(`${source}StatusText`);
      const countEl = document.getElementById(`${source}Count`);
      const lastUpdate = document.getElementById(`${source}LastUpdate`);
      
      if (statusDot) {
        statusDot.className = `status-dot ${status}`;
      }
      
      if (statusText) {
        statusText.textContent = status === 'online' ? '‚úÖ En ligne' : '‚ùå Hors ligne';
        statusText.style.color = status === 'online' ? 'var(--green)' : 'var(--red)';
      }
      
      if (countEl) {
        countEl.textContent = count;
      }
      
      if (lastUpdate && state.lastUpdate[source]) {
        const now = new Date();
        const diff = Math.floor((now - state.lastUpdate[source]) / 1000);
        lastUpdate.textContent = diff < 60 ? '√Ä l\'instant' : formatDate(state.lastUpdate[source]);
      }
    }

    // Afficher les √©v√©nements
    function displayEvents() {
      const container = document.getElementById('eventsContainer');
      const allEvents = [];
      
      // Convertir GitHub Advisories
      state.githubAdvisories.forEach(advisory => {
        allEvents.push({
          source: 'GitHub Security',
          title: advisory.summary || 'Avis de s√©curit√©',
          description: truncateDescription(advisory.description) || 'D√©tails non disponibles',
          severity: advisory.severity || 'low',
          time: advisory.published_at || advisory.updated_at,
          id: advisory.ghsa_id
        });
      });
      
      // Convertir CVEs
      state.cveData.forEach(item => {
        const cve = item.cve;
        if (!cve) return;
        
        const description = cve.descriptions?.find(d => d.lang === 'en')?.value || 'No description';
        const metrics = cve.metrics?.cvssMetricV31?.[0] || cve.metrics?.cvssMetricV2?.[0];
        const severity = metrics?.cvssData?.baseSeverity || 'LOW';
        
        allEvents.push({
          source: 'NVD/CVE',
          title: cve.id,
          description: truncateDescription(description),
          severity: severity,
          time: cve.published || cve.lastModified,
          id: cve.id
        });
      });
      
      // Trier par date (plus r√©cent d'abord)
      allEvents.sort((a, b) => new Date(b.time) - new Date(a.time));
      
      // Afficher
      if (allEvents.length === 0) {
        container.innerHTML = '<div class="error-message">‚ùå Aucun √©v√©nement charg√©. V√©rifiez la connexion aux APIs.</div>';
        return;
      }
      
      container.innerHTML = allEvents.map(event => `
        <div class="event-item">
          <div class="event-header">
            <span class="event-source">${event.source} ‚Ä¢ ${event.id}</span>
            <span class="event-time">${formatDate(event.time)}</span>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <span class="${getSeverityClass(event.severity)} severity-badge">${getSeverityText(event.severity)}</span>
          </div>
          <div class="event-title">${event.title}</div>
          <div class="event-description">${event.description}</div>
        </div>
      `).join('');
      
      // Mettre √† jour les totaux
      updateTotals(allEvents);
    }

    // Mettre √† jour les totaux
    function updateTotals(events) {
      const total = events.length;
      const critical = events.filter(e => 
        e.severity.toLowerCase() === 'critical'
      ).length;
      const highMedium = events.filter(e => 
        ['high', 'medium', 'moderate'].includes(e.severity.toLowerCase())
      ).length;
      
      document.getElementById('totalEvents').textContent = total;
      document.getElementById('criticalCount').textContent = critical;
      document.getElementById('highMediumCount').textContent = highMedium;
      document.getElementById('totalStatus').className = 'status-dot online';
      
      // Calculate global threat level
      updateGlobalThreatLevel(critical, highMedium, total);
    }

    // Calculate and update global threat level
    function updateGlobalThreatLevel(critical, highMedium, total) {
      const threatLevelEl = document.getElementById('threatLevel');
      const threatLevelBasisEl = document.getElementById('threatLevelBasis');
      const threatLevelTimeEl = document.getElementById('threatLevelTime');
      const threatLevelStatusEl = document.getElementById('threatLevelStatus');
      
      let level = 'FAIBLE';
      let color = 'var(--green)';
      let statusColor = 'online';
      
      // Calculate threat level based on critical and high/medium events
      const criticalRatio = total > 0 ? (critical / total) * 100 : 0;
      const highMediumRatio = total > 0 ? (highMedium / total) * 100 : 0;
      
      if (critical >= CONFIG.THREAT_LEVEL.CRITICAL_COUNT_HIGH || criticalRatio > CONFIG.THREAT_LEVEL.CRITICAL_RATIO_HIGH) {
        level = '√âLEV√â';
        color = 'var(--red)';
        statusColor = 'offline';
      } else if (critical >= 1 || highMedium >= CONFIG.THREAT_LEVEL.HIGH_MEDIUM_COUNT_MODERATE || highMediumRatio > CONFIG.THREAT_LEVEL.HIGH_MEDIUM_RATIO_MODERATE) {
        level = 'MOD√âR√â';
        color = 'var(--yellow)';
        statusColor = 'loading';
      }
      
      threatLevelEl.textContent = level;
      threatLevelEl.style.color = color;
      threatLevelBasisEl.textContent = `${critical} critiques, ${highMedium} moyens/√©lev√©s`;
      threatLevelTimeEl.textContent = new Date().toLocaleTimeString('fr-FR');
      threatLevelStatusEl.className = `status-dot ${statusColor}`;
    }

    // Mettre √† jour le statut syst√®me
    function updateSystemStatus() {
      const statusIndicator = document.getElementById('systemStatus');
      const statusText = document.getElementById('statusText');
      
      const allOnline = state.health.github === 'online' || state.health.cve === 'online';
      
      if (allOnline) {
        statusIndicator.className = 'live-indicator';
        statusText.textContent = 'OP√âRATIONNEL';
      } else {
        statusIndicator.className = 'live-indicator error';
        statusText.textContent = 'D√âGRAD√â';
      }
    }

    // Rafra√Æchir toutes les donn√©es
    async function refreshAllData() {
      const btn = document.getElementById('refreshBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Chargement...';
      
      await Promise.all([
        loadGitHubAdvisories(),
        loadCVEData()
      ]);
      
      displayEvents();
      updateSystemStatus();
      
      btn.disabled = false;
      btn.textContent = 'üîÑ Actualiser les donn√©es';
    }

    // Chargement initial
    window.addEventListener('DOMContentLoaded', () => {
      refreshAllData();
      
      // Auto-refresh selon CONFIG
      setInterval(refreshAllData, CONFIG.REFRESH_INTERVAL_MS);
    });
  </script>
</body>
</html>
