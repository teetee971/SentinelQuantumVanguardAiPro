<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Phase F Demo &amp; Testing â€” Sentinel</title>
  <style>
    :root{
      --bg:#0b0f14;
      --accent:#00e5ff;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --success:#10b981;
      --card:#0f172a;
      --border:#1f2937;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg, #020617 0%, #0b0f14 100%);
      color:var(--text);
      font-family:system-ui,sans-serif;
      padding:20px;
    }
    .container{max-width:1200px;margin:0 auto}
    h1{color:var(--accent);margin:0 0 20px}
    .section{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:12px;
      padding:20px;
      margin:20px 0;
    }
    h2{margin:0 0 16px;font-size:18px;color:var(--accent)}
    button{
      background:var(--accent);
      color:#000;
      border:none;
      padding:10px 20px;
      border-radius:8px;
      font-weight:600;
      cursor:pointer;
      margin:5px 5px 5px 0;
    }
    button:hover{opacity:0.9}
    pre{
      background:#000;
      padding:12px;
      border-radius:6px;
      overflow-x:auto;
      font-size:13px;
      margin:10px 0;
    }
    .badge{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      margin:3px;
    }
    .badge.green{background:#10b981;color:#fff}
    .badge.red{background:#ef4444;color:#fff}
    .badge.orange{background:#f59e0b;color:#000}
    .badge.gray{background:#6b7280;color:#fff}
    #output{
      background:#000;
      color:#0f0;
      padding:12px;
      border-radius:6px;
      min-height:200px;
      max-height:400px;
      overflow-y:auto;
      font-family:monospace;
      font-size:12px;
      margin-top:12px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª Phase F â€” Demo &amp; Testing Console</h1>
    <p style="color:var(--muted)">Cette page permet de tester les fonctionnalitÃ©s Phase F en toute sÃ©curitÃ©.</p>

    <!-- Feature Flags -->
    <div class="section">
      <h2>1. Feature Flags Status</h2>
      <button onclick="testFeatureFlags()">ğŸ“Š Check Feature Flags</button>
      <button onclick="testSystemStatus()">ğŸ” Get System Status</button>
      <div id="flags-status"></div>
    </div>

    <!-- Backend Testing -->
    <div class="section">
      <h2>2. Backend API (READ-ONLY)</h2>
      <button onclick="testHealth()">â¤ï¸ Health Check</button>
      <button onclick="testStatus()">ğŸ“ˆ System Status</button>
      <button onclick="testAgents()">ğŸ¤– List Agents</button>
      <button onclick="testMetrics()">ğŸ“Š Metrics</button>
      <button onclick="testWriteBlock()">ğŸš« Test Write Block</button>
    </div>

    <!-- Agent System -->
    <div class="section">
      <h2>3. AI Agent System</h2>
      <button onclick="testAgentInit()">ğŸ¯ Initialize Agents</button>
      <button onclick="testAgentExecute()">â–¶ï¸ Execute Agent (DORMANT)</button>
      <button onclick="testAgentSandbox()">ğŸ§ª Simulate SANDBOX Mode</button>
      <button onclick="testAgentStatus()">ğŸ“‹ Get Agent Status</button>
    </div>

    <!-- Logging System -->
    <div class="section">
      <h2>4. Unified Logging</h2>
      <button onclick="testLogging()">ğŸ“ Test Logging</button>
      <button onclick="testLogLevels()">ğŸšï¸ Test All Levels</button>
      <button onclick="testLogEvents()">ğŸ”” Test Events</button>
      <button onclick="clearOutput()">ğŸ§¹ Clear Output</button>
    </div>

    <!-- Emergency Controls -->
    <div class="section">
      <h2>5. Emergency Controls (SAFE TEST)</h2>
      <button onclick="testEmergencyShutdown()">ğŸš¨ Test Kill Switch</button>
      <button onclick="testRestore()">â™»ï¸ Test Restore</button>
      <p style="font-size:13px;color:var(--muted);margin:10px 0 0">
        âš ï¸ Ces tests n'affectent pas le systÃ¨me rÃ©el - simulation uniquement
      </p>
    </div>

    <!-- Output Console -->
    <div class="section">
      <h2>ğŸ“º Output Console</h2>
      <div id="output">
Ready. ExÃ©cutez un test pour voir les rÃ©sultats...\n
      </div>
    </div>
  </div>

  <script type="module">
    import { FEATURE_FLAGS, getSystemStatus, isFeatureEnabled, getAgentState, emergencyShutdown, restoreFromEmergency } from '../config/feature-flags.js';
    import { createBackendClient, sentinelFetch } from '../backend/backend.js';
    import agentSystem from '../ai-modules/agent-system.js';
    import { getLogger, LogLevel } from '../config/logging.js';

    const logger = getLogger('demo');
    const output = document.getElementById('output');
    
    function log(msg, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : type === 'warn' ? '#fa0' : '#0ff';
      output.innerHTML += `<span style="color:${color}">[${timestamp}] ${msg}</span>\n`;
      output.scrollTop = output.scrollHeight;
      console.log(msg);
    }

    window.testFeatureFlags = () => {
      log('=== FEATURE FLAGS ===', 'info');
      log(`FEATURE_BACKEND: ${FEATURE_FLAGS.FEATURE_BACKEND}`);
      log(`FEATURE_BACKEND_READ_ONLY: ${FEATURE_FLAGS.FEATURE_BACKEND_READ_ONLY}`, 'success');
      log(`FEATURE_AGENTS: ${FEATURE_FLAGS.FEATURE_AGENTS}`);
      log(`FEATURE_LOGS_LIVE: ${FEATURE_FLAGS.FEATURE_LOGS_LIVE}`);
      log(`EMERGENCY_SHUTDOWN: ${FEATURE_FLAGS.EMERGENCY_SHUTDOWN}`);
      log(`Phase: ${FEATURE_FLAGS.PHASE}, Mode: ${FEATURE_FLAGS.MODE}`, 'success');
    };

    window.testSystemStatus = () => {
      log('=== SYSTEM STATUS ===', 'info');
      const status = getSystemStatus();
      log(JSON.stringify(status, null, 2));
    };

    window.testHealth = async () => {
      log('=== BACKEND HEALTH CHECK ===', 'info');
      try {
        const response = await sentinelFetch('/api/v1/health');
        const data = await response.json();
        log('Health check successful:', 'success');
        log(JSON.stringify(data, null, 2));
      } catch (e) {
        log(`Error: ${e.message}`, 'error');
      }
    };

    window.testStatus = async () => {
      log('=== BACKEND STATUS ===', 'info');
      try {
        const response = await sentinelFetch('/api/v1/system/status');
        const data = await response.json();
        log('Status retrieved:', 'success');
        log(JSON.stringify(data, null, 2));
      } catch (e) {
        log(`Error: ${e.message}`, 'error');
      }
    };

    window.testAgents = async () => {
      log('=== LIST AGENTS ===', 'info');
      try {
        const response = await sentinelFetch('/api/v1/agents');
        const data = await response.json();
        log(`Found ${data.agents.length} agents:`, 'success');
        data.agents.forEach(agent => {
          log(`- ${agent.name} (${agent.id}): ${agent.status}`);
        });
      } catch (e) {
        log(`Error: ${e.message}`, 'error');
      }
    };

    window.testMetrics = async () => {
      log('=== SYSTEM METRICS ===', 'info');
      try {
        const response = await sentinelFetch('/api/v1/monitoring/metrics');
        const data = await response.json();
        log('Metrics:', 'success');
        log(`CPU: ${data.cpu.toFixed(2)}%`);
        log(`Memory: ${data.memory.toFixed(2)}%`);
        log(`Disk: ${data.disk.toFixed(2)}%`);
      } catch (e) {
        log(`Error: ${e.message}`, 'error');
      }
    };

    window.testWriteBlock = async () => {
      log('=== TEST WRITE BLOCK (should fail) ===', 'warn');
      const backend = createBackendClient();
      try {
        await backend.updateAgent('network-guardian', { test: true });
        log('Unexpected: Write operation succeeded', 'error');
      } catch (e) {
        log(`âœ… Write blocked correctly: ${e.message}`, 'success');
      }
    };

    window.testAgentInit = async () => {
      log('=== INITIALIZE AGENTS ===', 'info');
      try {
        await agentSystem.initialize();
        const statuses = agentSystem.getAllStatuses();
        log(`Initialized ${statuses.length} agents:`, 'success');
        statuses.forEach(s => {
          log(`- ${s.name}: ${s.state}`);
        });
      } catch (e) {
        log(`Error: ${e.message}`, 'error');
      }
    };

    window.testAgentExecute = async () => {
      log('=== EXECUTE AGENT (DORMANT) ===', 'info');
      try {
        const results = await agentSystem.executeAll();
        log('Execution results:', 'success');
        results.forEach(r => {
          log(`- ${r.agentId}: ${r.action} (${r.message})`);
        });
      } catch (e) {
        log(`Error: ${e.message}`, 'error');
      }
    };

    window.testAgentSandbox = async () => {
      log('=== SIMULATE SANDBOX MODE ===', 'warn');
      log('Note: This is a simulation - feature flag not changed');
      const agent = agentSystem.getAgent('network-guardian');
      if (!agent) {
        log('Agent not initialized', 'error');
        return;
      }
      
      // Temporarily simulate sandbox state
      const originalState = agent.state;
      agent.state = 'SANDBOX';
      
      const result = await agent.executeSandbox();
      log('Sandbox execution:', 'success');
      log(JSON.stringify(result, null, 2));
      
      // Restore
      agent.state = originalState;
      log('State restored to DORMANT', 'info');
    };

    window.testAgentStatus = () => {
      log('=== AGENT STATUS ===', 'info');
      const agent = agentSystem.getAgent('network-guardian');
      if (!agent) {
        log('Agent not initialized - run Initialize first', 'error');
        return;
      }
      const status = agent.getStatus();
      log(JSON.stringify(status, null, 2));
    };

    window.testLogging = () => {
      log('=== TEST LOGGING SYSTEM ===', 'info');
      logger.debug('This is a debug message');
      logger.info('This is an info message');
      logger.warn('This is a warning message');
      logger.error('This is an error message');
      log('âœ… Logged 4 messages - check browser console', 'success');
    };

    window.testLogLevels = () => {
      log('=== TEST ALL LOG LEVELS ===', 'info');
      Object.values(LogLevel).forEach(level => {
        logger.log(level, `Test message at ${level} level`, { test: true });
      });
      log('âœ… Tested all log levels', 'success');
    };

    window.testLogEvents = () => {
      log('=== TEST LOG EVENTS ===', 'info');
      let eventCount = 0;
      
      const listener = (e) => {
        eventCount++;
        log(`Event received: ${e.detail.level} - ${e.detail.message}`, 'success');
      };
      
      window.addEventListener('sentinel:log', listener);
      
      logger.info('Test event message 1');
      logger.info('Test event message 2');
      
      setTimeout(() => {
        window.removeEventListener('sentinel:log', listener);
        log(`âœ… Received ${eventCount} log events`, 'success');
      }, 100);
    };

    window.testEmergencyShutdown = () => {
      log('=== TEST EMERGENCY SHUTDOWN ===', 'warn');
      log('âš ï¸ THIS IS A SAFE TEST - NOT ACTUAL SHUTDOWN', 'warn');
      
      const result = emergencyShutdown();
      log('Kill switch activated (test):', 'success');
      log(JSON.stringify(result, null, 2));
      
      const status = getSystemStatus();
      log(`Kill switch active: ${status.killSwitchActive}`, status.killSwitchActive ? 'warn' : 'success');
      
      log('âš ï¸ Restoring automatically in 2 seconds...', 'info');
      setTimeout(() => {
        restoreFromEmergency();
        log('âœ… System restored from test shutdown', 'success');
      }, 2000);
    };

    window.testRestore = () => {
      log('=== TEST RESTORE FROM EMERGENCY ===', 'info');
      const result = restoreFromEmergency();
      log('Restore result:', 'success');
      log(JSON.stringify(result, null, 2));
    };

    window.clearOutput = () => {
      output.innerHTML = 'Output cleared.\n';
    };

    // Initialize on load
    log('Phase F Demo Console Ready!', 'success');
    log('Click buttons above to test features.', 'info');
  </script>
</body>
</html>
