name: ğŸ›¡ï¸ Sentinel Security Pulse

on:
  schedule:
    - cron: '0 */6 * * *' # toutes les 6 heures
  workflow_dispatch:

jobs:
  security_audit:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ğŸ“¦ Installer les dÃ©pendances
        run: |
          npm install -g pnpm
          pnpm install --frozen-lockfile

      - name: ğŸ” Audit sÃ©curitÃ© PNPM
        run: |
          mkdir -p security
          pnpm audit --json > security/pnpm-audit.json || true
          echo "âœ… Audit PNPM terminÃ©"

      - name: ğŸ” Audit sÃ©curitÃ© NPM
        run: |
          npm audit --json > security/npm-audit.json || true
          echo "âœ… Audit NPM terminÃ©"

      - name: ğŸ§© Scanner les signatures de modules IA
        run: |
          echo "ğŸ”¬ Analyse des modules sensibles IA..."
          grep -i "openai\\|gemini\\|deepl\\|firebase\\|supabase" package.json > security/ai-modules.txt || echo "Aucun module IA dÃ©tectÃ©" > security/ai-modules.txt
          echo "âœ… Scan des modules IA terminÃ©"

      - name: ğŸ§  GÃ©nÃ©ration du rapport HTML
        run: |
          mkdir -p public/security
          echo "<html><head><title>Sentinel Security Pulse</title><meta http-equiv='refresh' content='600'></head><body style='font-family:monospace;background:#0d1117;color:#e6edf3;padding:20px;'>" > public/security/index.html
          echo "<h2>ğŸ›¡ï¸ Sentinel Security Pulse</h2><hr>" >> public/security/index.html
          echo "<h3>ğŸ“¦ PNPM Audit</h3><pre>" >> public/security/index.html
          jq '.advisories // .vulnerabilities // {}' security/pnpm-audit.json >> public/security/index.html || echo "Aucune vulnÃ©rabilitÃ© critique dÃ©tectÃ©e." >> public/security/index.html
          echo "</pre><h3>ğŸ“¦ NPM Audit</h3><pre>" >> public/security/index.html
          jq '.advisories // .vulnerabilities // {}' security/npm-audit.json >> public/security/index.html || echo "Aucune vulnÃ©rabilitÃ© critique dÃ©tectÃ©e." >> public/security/index.html
          echo "</pre><h3>ğŸ¤– Modules IA dÃ©tectÃ©s</h3><pre>" >> public/security/index.html
          cat security/ai-modules.txt >> public/security/index.html
          echo "</pre><hr><p>ğŸ•’ DerniÃ¨re mise Ã  jour : $(date)</p></body></html>" >> public/security/index.html
          echo "âœ… Rapport HTML gÃ©nÃ©rÃ©"

      - name: ğŸš€ Publier le rapport sur Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: sentinelquantumvanguardaipro
          directory: public
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¡ Envoyer rÃ©sumÃ© sur Telegram
        run: |
          ALERTS=$(jq length security/pnpm-audit.json)
          MSG="ğŸ›¡ï¸ Sentinel Security Pulse\nVulnÃ©rabilitÃ©s critiques : ${ALERTS}\nModules IA scannÃ©s : $(wc -l < security/ai-modules.txt)\nğŸ•’ $(date)"
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="$MSG"

      - name: âœ… Fin du cycle Security Pulse
        run: echo "âœ”ï¸ Sentinel Security Pulse terminÃ© avec succÃ¨s."