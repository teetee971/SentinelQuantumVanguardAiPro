name: üß† Sentinel Cognitive Monitor AI ‚Äî Deep Site Validation

on:
  schedule:
    - cron: "*/30 * * * *" # V√©rification toutes les 30 minutes
  workflow_dispatch:

jobs:
  cognitive-scan:
    runs-on: ubuntu-latest

    steps:
      - name: üîç Analyse cognitive du site Sentinel
        id: scan
        run: |
          URL="https://sentinelquantumvanguardaipro.pages.dev"
          echo "üß† Analyse du contenu du site : $URL"
          RESPONSE=$(curl -s -L $URL)
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" $URL)

          echo "Code HTTP : $STATUS" 
          echo "Longueur de la r√©ponse : $(echo "$RESPONSE" | wc -c)"

          if [ "$STATUS" -ne 200 ]; then
            echo "‚ö†Ô∏è Site renvoie un code HTTP anormal ($STATUS)"
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "details=HTTP Status $STATUS" >> $GITHUB_OUTPUT
            exit 0
          fi

          # D√©tection de contenu suspect
          if echo "$RESPONSE" | grep -iqE "error|404|not found|deployment failed|vite error|500"; then
            echo "‚ö†Ô∏è Anomalie d√©tect√©e dans le contenu."
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "details=Anomalie de contenu HTML d√©tect√©e" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "$(echo "$RESPONSE" | wc -c)" -lt 500 ]; then
            echo "‚ö†Ô∏è R√©ponse trop courte (contenu incomplet ou vide)"
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "details=R√©ponse trop courte (<500 octets)" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "‚úÖ Analyse cognitive r√©ussie : contenu HTML coh√©rent."
          echo "result=success" >> $GITHUB_OUTPUT
          echo "details=OK" >> $GITHUB_OUTPUT

      - name: ‚úÖ Notification Telegram (succ√®s)
        if: steps.scan.outputs.result == 'success'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          MSG="‚úÖ *Sentinel Cognitive Monitor AI* : site fonctionnel et coh√©rent.%0Aüß© Analyse r√©ussie.%0Aüåê https://sentinelquantumvanguardaipro.pages.dev"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=$MSG" \
            -d "parse_mode=Markdown"

      - name: üö® Notification Telegram (anomalie d√©tect√©e)
        if: steps.scan.outputs.result == 'failure'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          DETAILS="${{ steps.scan.outputs.details }}"
          MSG="üö® *ALERTE IA SENTINEL* : anomalie d√©tect√©e sur le site.%0Aüîç D√©tail : $DETAILS%0A‚ö†Ô∏è Contenu suspect d√©tect√©.%0Aüåê https://sentinelquantumvanguardaipro.pages.dev"
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TELEGRAM_CHAT_ID}" \
            -d "text=$MSG" \
            -d "parse_mode=Markdown"